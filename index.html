<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Portfolio Pro - Neon Verse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: { dark: '#050505', card: 'rgba(20, 20, 25, 0.85)', input: 'rgba(255, 255, 255, 0.05)' },
                        neon: { gold: '#FFD700', blue: '#00F0FF', pink: '#FF00FF', green: '#00FF9D', red: '#FF4D4D' }
                    },
                    fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { pulseSlow: 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>

    <style>
        body { background: radial-gradient(circle at 50% -20%, #1a1c29 0%, #050505 100%); color: #EAECEF; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .glass-panel { background: rgba(20, 20, 25, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .input-modern { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .input-modern:focus { border-color: #00F0FF; box-shadow: 0 0 10px rgba(0, 240, 255, 0.2); }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .hide-on-mobile { display: none; }
            .glass-panel { padding: 1rem; } /* Reduce padding on mobile */
            th, td { padding: 0.75rem 0.5rem; }
        }

        /* Buttons */
        .btn-neon { position: relative; overflow: hidden; transition: all 0.3s ease; text-shadow: 0 0 5px rgba(255,255,255,0.3); border: 1px solid transparent; }
        .btn-neon-blue { background: linear-gradient(135deg, rgba(0, 240, 255, 0.1), rgba(0, 240, 255, 0.05)); border-color: rgba(0, 240, 255, 0.4); color: #00F0FF; }
        .btn-neon-blue:hover { background: rgba(0, 240, 255, 0.2); box-shadow: 0 0 15px rgba(0, 240, 255, 0.4); transform: translateY(-1px); }
        .btn-neon-pink { background: linear-gradient(135deg, rgba(255, 0, 255, 0.1), rgba(255, 0, 255, 0.05)); border-color: rgba(255, 0, 255, 0.4); color: #FF00FF; }
        .btn-neon-pink:hover { background: rgba(255, 0, 255, 0.2); box-shadow: 0 0 15px rgba(255, 0, 255, 0.4); transform: translateY(-1px); }
        .btn-neon-red { background: linear-gradient(135deg, rgba(255, 77, 77, 0.1), rgba(255, 77, 77, 0.05)); border-color: rgba(255, 77, 77, 0.4); color: #FF4D4D; }
        .btn-neon-red:hover { background: rgba(255, 77, 77, 0.2); box-shadow: 0 0 15px rgba(255, 77, 77, 0.4); transform: translateY(-1px); }
        .btn-solid-gold { background: linear-gradient(90deg, #F0B90B, #d49e06); color: black; font-weight: bold; box-shadow: 0 0 10px rgba(240, 185, 11, 0.3); }
        .btn-solid-gold:hover { box-shadow: 0 0 20px rgba(240, 185, 11, 0.6); }
        
        /* UI Elements */
        .tab-active { border-bottom: 2px solid #00F0FF; color: #00F0FF; text-shadow: 0 0 8px rgba(0, 240, 255, 0.5); }
        .tab-inactive { color: #848E9C; }
        .neon-option { transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); }
        .neon-option.active { border-color: #00F0FF; background: rgba(0, 240, 255, 0.05); box-shadow: 0 0 15px rgba(0, 240, 255, 0.3); }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: rgba(255, 255, 255, 0.05); }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Toast */
        .toast-container { position: fixed; bottom: 20px; right: 20px; left: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; align-items: flex-end; }
        @media (max-width: 768px) { .toast-container { align-items: center; bottom: 80px; } }
        .toast { pointer-events: auto; background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(10px); border: 1px solid #333; color: #fff; padding: 12px 20px; border-radius: 8px; display: flex; items-center; gap: 12px; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); min-width: 280px; max-width: 100%; }
        .toast.success { border-left: 4px solid #00ff9d; }
        .toast.error { border-left: 4px solid #ff4d4d; }
        .toast.info { border-left: 4px solid #00F0FF; }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }

        /* Ticker Marquee */
        .ticker-wrap { width: 100%; overflow: hidden; white-space: nowrap; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }
        .ticker-content { display: inline-block; animation: marquee 40s linear infinite; }
        .ticker-content:hover { animation-play-state: paused; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        
        .quick-action-btn { transition: all 0.2s; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); }
        .quick-action-btn:hover { background: rgba(0, 240, 255, 0.1); border-color: #00F0FF; transform: translateY(-2px); }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans selection:bg-neon-blue selection:text-black pb-20 md:pb-0">

    <div id="toast-container" class="toast-container"></div>

    <div class="bg-black/60 border-b border-white/5 py-2 px-4 flex items-center overflow-hidden h-10">
        <div class="flex items-center gap-2 text-[10px] md:text-xs font-mono text-neon-blue shrink-0 mr-4 z-10 bg-opacity-80 bg-black/20 backdrop-blur-sm pr-4 border-r border-white/10">
            <i class="fa-solid fa-chart-line"></i> LIVE
        </div>
        <div id="top-coins-ticker" class="flex-1 overflow-hidden">
            <span class="text-gray-500 text-xs">Loading Market Data...</span>
        </div>
    </div>

    <header class="glass-panel sticky top-0 z-40">
        <div class="container mx-auto px-4 h-16 md:h-20 flex items-center justify-between">
            <div class="flex items-center gap-3 md:gap-4 cursor-pointer hover:opacity-80 transition" onclick="location.reload()">
                <div class="relative w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-tr from-yellow-400 to-yellow-600 flex items-center justify-center text-black font-bold text-lg md:text-2xl shadow-[0_0_15px_rgba(250,204,21,0.5)]">
                    <i class="fa-brands fa-bitcoin"></i>
                    <div class="absolute -bottom-1 -right-1 w-2 md:w-3 h-2 md:h-3 bg-neon-green rounded-full animate-pulse"></div>
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold tracking-tight text-white leading-tight drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">NEON PORTFOLIO</h1>
                    <div class="text-[8px] md:text-[10px] text-neon-blue tracking-[0.2em] uppercase font-bold">Future Finance</div>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-3">
                <div class="hidden md:flex gap-2 mr-2 border-r border-gray-700 pr-4">
                    <button onclick="app.exportData()" class="text-xs text-gray-400 hover:text-neon-green transition flex items-center gap-1"><i class="fa-solid fa-download"></i> Backup</button>
                    <button onclick="document.getElementById('file-upload').click()" class="text-xs text-gray-400 hover:text-neon-blue transition flex items-center gap-1"><i class="fa-solid fa-upload"></i> Restore</button>
                    <input type="file" id="file-upload" class="hidden" onchange="app.importData(this)">
                </div>

                <button onclick="app.updateMarketData()" class="btn-neon btn-neon-blue text-xs font-bold p-2 md:py-2 md:px-4 rounded-lg flex items-center gap-2">
                    <i class="fa-solid fa-sync" id="refresh-icon"></i> <span class="hidden md:inline">Refresh</span>
                </button>
                <button onclick="app.toggleTrashModal()" class="relative p-2 md:p-3 text-gray-500 hover:text-red-400 transition">
                    <i class="fa-solid fa-trash-can text-lg"></i>
                    <span id="trashCount" class="absolute top-1 right-1 bg-red-600 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full hidden shadow-[0_0_5px_#ef4444]">0</span>
                </button>
                <button onclick="app.openAddTransactionModal()" class="btn-solid-gold hover:bg-yellow-400 text-black text-sm font-bold p-2 md:py-2.5 md:px-6 rounded-lg transition transform active:scale-95 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> <span class="hidden md:inline">Giao dịch</span>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 container mx-auto px-2 md:px-4 py-4 md:py-8">
        
        <div class="flex border-b border-gray-800 mb-6 md:mb-8 overflow-x-auto gap-2 md:gap-4 no-scrollbar">
            <button onclick="app.switchTab('portfolio')" id="tab-portfolio" class="tab-active py-3 px-3 md:px-4 font-bold text-xs md:text-sm tracking-wide transition uppercase whitespace-nowrap">
                <i class="fa-solid fa-chart-pie mr-1 md:mr-2"></i>Tổng quan
            </button>
            <button onclick="app.switchTab('history')" id="tab-history" class="tab-inactive py-3 px-3 md:px-4 font-bold text-xs md:text-sm tracking-wide transition uppercase whitespace-nowrap">
                <i class="fa-solid fa-list-ul mr-1 md:mr-2"></i>Lịch sử
            </button>
            <button onclick="app.switchTab('di')" id="tab-di" class="tab-inactive py-3 px-3 md:px-4 font-bold text-xs md:text-sm tracking-wide transition uppercase whitespace-nowrap">
                <i class="fa-solid fa-robot mr-1 md:mr-2"></i>Dual Investment
            </button>
        </div>

        <div id="view-portfolio" class="animate-fade-in space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6">
                <div class="glass-panel p-4 md:p-6 rounded-2xl border-t-2 border-neon-gold relative overflow-hidden col-span-2 md:col-span-1">
                    <div class="text-gray-400 text-[10px] md:text-xs uppercase font-bold tracking-widest mb-2">Tổng tài sản (Equity)</div>
                    <div class="flex items-center gap-2">
                        <div class="text-2xl md:text-3xl font-bold text-white font-mono drop-shadow-[0_0_10px_rgba(255,215,0,0.3)]" id="total-balance">$0.00</div>
                        <button onclick="app.togglePrivacy()" class="text-gray-500 hover:text-white transition p-1"><i class="fa-solid fa-eye" id="privacy-icon"></i></button>
                    </div>
                    <div class="text-[10px] md:text-xs text-neon-green mt-2 flex items-center gap-1">
                        <i class="fa-solid fa-wallet"></i> Avail: <span id="usdt-available" class="font-bold text-white ml-1">0.00</span> USDT
                    </div>
                </div>
                <div class="glass-panel p-4 md:p-6 rounded-2xl border-t-2 border-gray-500">
                    <div class="text-gray-400 text-[10px] md:text-xs uppercase font-bold tracking-widest mb-2">Vốn thực (Net Cost)</div>
                    <div class="text-xl md:text-3xl font-bold text-white font-mono" id="total-invested">$0.00</div>
                    <div class="text-[10px] md:text-xs text-gray-500 mt-2">Tổng Nạp - Rút</div>
                </div>
                <div class="glass-panel p-4 md:p-6 rounded-2xl border-t-2 border-neon-blue">
                    <div class="text-gray-400 text-[10px] md:text-xs uppercase font-bold tracking-widest mb-2">Unrealized PnL</div>
                    <div class="text-xl md:text-3xl font-bold font-mono" id="unrealized-pnl">$0.00</div>
                    <div class="text-xs md:text-sm font-bold mt-1" id="unrealized-pnl-pct">0.00%</div>
                </div>
                <div class="glass-panel p-4 md:p-6 rounded-2xl border-t-2 border-neon-pink">
                    <div class="text-gray-400 text-[10px] md:text-xs uppercase font-bold tracking-widest mb-2">Realized PnL</div>
                    <div class="text-xl md:text-3xl font-bold font-mono" id="realized-pnl">$0.00</div>
                    <div class="text-[10px] md:text-xs text-gray-500 mt-2">Đã chốt lời</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                <div class="glass-panel p-4 md:p-6 rounded-2xl lg:col-span-1 h-fit">
                    <h3 class="text-xs md:text-sm font-bold mb-4 text-neon-blue uppercase tracking-widest border-b border-gray-800 pb-2">Phân bổ tài sản</h3>
                    <div class="flex flex-col items-center">
                        <div class="relative w-48 h-48 md:w-56 md:h-56 mb-4">
                            <canvas id="portfolioChart"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <span class="text-[10px] text-gray-600 font-mono tracking-widest">ASSETS</span>
                            </div>
                        </div>
                        <div id="chart-legend" class="w-full mt-2 max-h-48 overflow-y-auto pr-1 custom-scrollbar space-y-2"></div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-panel p-4 md:p-6 rounded-2xl">
                        <h3 class="text-xs md:text-sm font-bold mb-4 text-neon-green uppercase tracking-widest border-b border-gray-800 pb-2">
                            <i class="fa-solid fa-arrow-trend-up mr-2"></i>Hiệu suất Tài sản (Daily Snapshot)
                        </h3>
                        <div class="relative w-full h-48 md:h-64">
                            <canvas id="performanceChart"></canvas>
                            <div id="perf-chart-empty" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 text-xs hidden">
                                <i class="fa-solid fa-chart-line text-2xl mb-2 opacity-50"></i>
                                Dữ liệu sẽ xuất hiện vào ngày mai
                            </div>
                        </div>
                    </div>

                    <div class="glass-panel p-4 md:p-6 rounded-2xl overflow-x-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xs md:text-sm font-bold text-white uppercase tracking-widest border-b border-gray-800 pb-2">Danh mục Holdings</h3>
                            <label class="flex items-center cursor-pointer gap-2 select-none">
                                <input type="checkbox" id="hide-small-assets" class="sr-only peer" onchange="app.toggleSmallAssets()">
                                <div class="w-7 h-4 md:w-9 md:h-5 bg-gray-700 rounded-full peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 md:after:h-4 md:after:w-4 after:transition-all peer-checked:bg-neon-green relative"></div>
                                <span class="text-[10px] md:text-xs text-gray-400 font-bold">Ẩn rác</span>
                            </label>
                        </div>
                        <table class="w-full text-left border-collapse min-w-[500px]">
                            <thead>
                                <tr class="text-[10px] md:text-xs text-gray-500 border-b border-gray-800 uppercase tracking-wider font-mono">
                                    <th class="py-3 px-2">Coin</th>
                                    <th class="py-3 px-2 text-right">Holdings</th>
                                    <th class="py-3 px-2 text-right hide-on-mobile">Avg Price</th>
                                    <th class="py-3 px-2 text-right">Price</th>
                                    <th class="py-3 px-2 text-right">Value</th>
                                    <th class="py-3 px-2 text-right">PnL</th>
                                </tr>
                            </thead>
                            <tbody id="assets-table-body" class="text-sm font-medium text-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-history" class="hidden animate-fade-in">
            <div class="glass-panel p-4 md:p-5 rounded-2xl mb-6 flex flex-col gap-5 border border-neon-blue/20">
                <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
                    <div class="flex flex-wrap gap-2 w-full md:w-auto items-center">
                        <select id="filter-type" onchange="app.renderHistory()" class="bg-black/40 border border-gray-700 text-gray-200 text-xs rounded-lg px-3 py-2 outline-none">
                            <option value="all">Tất cả</option>
                            <option value="buy_usdt">Mua (Spot)</option>
                            <option value="sell_usdt">Bán (Spot)</option>
                            <option value="fiat_usdt">Nạp/Rút</option>
                            <option value="transfer">Chuyển đi</option>
                        </select>
                        <input type="text" id="filter-pair" oninput="app.renderHistory()" placeholder="COIN..." class="bg-black/40 border border-gray-700 text-gray-200 text-xs rounded-lg px-3 py-2 outline-none w-24 uppercase font-mono">
                        <button onclick="app.toggleSort()" class="bg-black/40 border border-gray-700 text-gray-300 p-2 rounded-lg"><i class="fa-solid fa-sort"></i></button>
                    </div>
                    <div id="history-bulk-actions" class="hidden bg-red-900/30 p-2 rounded-lg border border-red-500/50 flex items-center gap-2">
                        <span class="text-xs text-red-200 ml-1">Chọn: <span id="history-selected-count">0</span></span>
                        <button onclick="app.deleteSelectedHistory()" class="text-[10px] bg-red-600 text-white px-2 py-1 rounded">Xóa</button>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-xl border border-gray-800">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead class="bg-black/40 text-xs text-gray-400 uppercase tracking-widest font-mono">
                            <tr>
                                <th class="p-3 w-8 text-center"><input type="checkbox" id="history-check-all" onclick="app.toggleAllHistory()" class="accent-neon-blue"></th>
                                <th class="p-3">Time</th>
                                <th class="p-3">Type</th>
                                <th class="p-3">Detail</th>
                                <th class="p-3 text-right">Price</th>
                                <th class="p-3 text-right">Amount</th>
                                <th class="p-3 text-right">Total</th>
                                <th class="p-3 text-center">Act</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="text-xs md:text-sm divide-y divide-gray-800 text-gray-300"></tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center pt-2">
                    <span class="text-xs text-gray-500" id="pagination-info">Page 1</span>
                    <div class="flex gap-2">
                        <button onclick="app.prevPage()" class="p-2 bg-gray-800 rounded disabled:opacity-30" id="btn-prev"><i class="fa-solid fa-chevron-left"></i></button>
                        <button onclick="app.nextPage()" class="p-2 bg-gray-800 rounded disabled:opacity-30" id="btn-next"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-di" class="hidden animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl md:text-2xl font-bold text-white flex items-center gap-3">
                    <i class="fa-solid fa-robot text-neon-pink"></i> Dual Investment
                </h2>
                <div class="flex gap-2 w-full md:w-auto">
                    <div class="glass-panel px-3 py-2 rounded-lg border border-neon-gold/30 flex-1 md:flex-none">
                        <div class="text-[10px] text-gray-400 uppercase font-bold">Tổng Lãi</div>
                        <div class="text-white font-mono font-bold text-sm" id="di-total-rewards">...</div>
                    </div>
                    <button onclick="app.openDIModal()" class="btn-neon btn-neon-pink text-xs font-bold py-2 px-4 rounded-lg flex items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-plus"></i> Tạo gói
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xs font-bold text-neon-green mb-4 uppercase tracking-widest border-b border-gray-800 pb-2">Đang hoạt động</h3>
                    <div class="grid grid-cols-1 gap-4" id="di-list-active"></div>
                </div>
                <div>
                    <div class="flex justify-between items-end mb-4 border-b border-gray-800 pb-2">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Lịch sử</h3>
                        <div id="di-bulk-actions" class="hidden flex items-center gap-2">
                            <span class="text-xs text-gray-400">Chọn: <b id="di-selected-count" class="text-white">0</b></span>
                            <button onclick="app.deleteSelectedDI()" class="text-[10px] bg-red-600 text-white px-2 py-1 rounded">Xóa</button>
                        </div>
                    </div>
                    <div class="glass-panel rounded-2xl overflow-hidden border border-gray-800 h-[500px] overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left text-xs md:text-sm">
                            <thead class="bg-black/40 text-[10px] text-gray-500 font-mono uppercase sticky top-0 z-10 backdrop-blur-sm">
                                <tr>
                                    <th class="p-3 w-8 text-center"><input type="checkbox" id="di-check-all" onclick="app.toggleAllDIHistory()" class="accent-neon-pink"></th>
                                    <th class="p-3">Ngày</th>
                                    <th class="p-3">Asset</th>
                                    <th class="p-3">Result</th>
                                    <th class="p-3 text-center">Del</th>
                                </tr>
                            </thead>
                            <tbody id="di-list-history" class="divide-y divide-gray-800 cursor-pointer"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-black/90 border-t border-gray-800 flex justify-around py-3 z-50 backdrop-blur-md pb-safe">
        <button onclick="app.switchTab('portfolio')" class="text-gray-400 hover:text-neon-blue flex flex-col items-center gap-1">
            <i class="fa-solid fa-chart-pie text-lg"></i><span class="text-[10px]">Home</span>
        </button>
        <button onclick="app.openAddTransactionModal()" class="text-black bg-neon-gold rounded-full w-10 h-10 flex items-center justify-center -mt-5 shadow-[0_0_10px_#FFD700]">
            <i class="fa-solid fa-plus text-xl"></i>
        </button>
        <button onclick="app.switchTab('history')" class="text-gray-400 hover:text-neon-blue flex flex-col items-center gap-1">
            <i class="fa-solid fa-list-ul text-lg"></i><span class="text-[10px]">History</span>
        </button>
    </div>

    <div id="modal-transaction" class="fixed inset-0 bg-black/90 hidden items-end md:items-center justify-center z-[70] backdrop-blur-md">
        <div class="glass-panel w-full md:max-w-xl rounded-t-2xl md:rounded-2xl border border-gray-700 overflow-hidden transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
            <div class="bg-black/60 px-6 py-4 flex justify-between items-center border-b border-gray-800 sticky top-0 z-10 backdrop-blur-md">
                <h3 class="text-lg font-bold text-white tracking-wide" id="modal-title">THÊM GIAO DỊCH</h3>
                <button onclick="app.closeModal('transaction')" class="text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="flex border-b border-gray-800 sticky top-[60px] z-10 bg-black/80">
                <button onclick="app.switchModalTab('spot')" id="modal-tab-spot" class="flex-1 py-4 text-xs md:text-sm font-bold bg-transparent text-neon-gold border-b-2 border-neon-gold transition uppercase">Spot</button>
                <button onclick="app.switchModalTab('fiat')" id="modal-tab-fiat" class="flex-1 py-4 text-xs md:text-sm font-bold bg-transparent text-gray-500 hover:text-gray-300 transition uppercase">Fiat</button>
                <button onclick="app.switchModalTab('transfer')" id="modal-tab-transfer" class="flex-1 py-4 text-xs md:text-sm font-bold bg-transparent text-gray-500 hover:text-gray-300 transition uppercase">Transfer</button>
            </div>

            <div class="p-6 pb-24 md:pb-6">
                <form id="form-spot" class="space-y-4">
                    <div class="flex gap-3">
                        <div class="w-1/2">
                            <label class="block text-[10px] text-gray-400 uppercase tracking-wider mb-1">Loại lệnh</label>
                            <div class="flex bg-black/40 rounded-lg p-1 border border-gray-700">
                                <label class="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold transition bg-emerald-600 text-white" id="lbl-buy">
                                    <input type="radio" name="spotType" value="buy" checked class="hidden" onchange="app.toggleSpotType('buy')"> MUA
                                </label>
                                <label class="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold text-gray-500 transition" id="lbl-sell">
                                    <input type="radio" name="spotType" value="sell" class="hidden" onchange="app.toggleSpotType('sell')"> BÁN
                                </label>
                            </div>
                        </div>
                        <div class="w-1/2">
                            <label class="block text-[10px] text-gray-400 uppercase tracking-wider mb-1">Thời gian</label>
                            <input type="datetime-local" id="spot-date" class="input-modern w-full rounded-lg px-2 py-2 text-white text-xs outline-none">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-neon-blue uppercase tracking-wider mb-1">Coin</label>
                            <div class="flex relative">
                                <input type="text" id="spot-coin" oninput="app.onSpotCoinInput(this.value)" class="input-modern w-full rounded-lg px-3 py-2 text-white uppercase font-bold outline-none pl-3" placeholder="BTC">
                                <button type="button" onclick="app.fetchSpotPriceInModal()" class="absolute right-1 top-1 bottom-1 px-2 bg-gray-800 hover:bg-gray-700 rounded text-[9px] text-neon-gold border border-gray-700">PRICE</button>
                            </div>
                            <div id="spot-balance-display" class="text-[9px] text-gray-400 mt-1 font-mono text-right">Avail: -</div>
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase tracking-wider mb-1">Giá (USDT)</label>
                            <input type="number" id="spot-price" step="any" oninput="app.calculateSpotLogic('price')" class="input-modern w-full rounded-lg px-3 py-2 text-white outline-none font-mono text-neon-gold">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase tracking-wider mb-1">Số lượng</label>
                            <div class="relative">
                                <input type="number" id="spot-amount" step="any" oninput="app.calculateSpotLogic('amount')" class="input-modern w-full rounded-lg px-3 py-2 text-white outline-none font-mono font-bold pr-10">
                                <button type="button" onclick="app.setMaxAmount('spot')" class="absolute right-1 top-1 bottom-1 px-1.5 bg-neon-blue/20 text-neon-blue hover:bg-neon-blue/40 rounded text-[9px] font-bold">MAX</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase tracking-wider mb-1">Tổng USDT</label>
                            <input type="number" id="spot-total" step="any" oninput="app.calculateSpotLogic('total')" class="input-modern w-full rounded-lg px-3 py-2 text-white outline-none font-mono font-bold">
                        </div>
                    </div>
                    
                    <button type="button" onclick="app.saveSpotTransaction()" class="btn-solid-gold w-full py-3 rounded-lg mt-4 text-sm uppercase font-bold" id="btn-save-spot">Xác Nhận</button>
                </form>

                <form id="form-fiat" class="space-y-4 hidden">
                    <div class="flex gap-4">
                        <div class="w-1/2">
                            <label class="block text-[10px] text-gray-400 mb-1">Loại</label>
                            <div class="flex bg-black/40 rounded-lg p-1 border border-gray-700">
                                <label class="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold bg-blue-600 text-white" id="lbl-deposit">
                                    <input type="radio" name="fiatType" value="deposit" checked class="hidden" onchange="app.toggleFiatType('deposit')"> NẠP
                                </label>
                                <label class="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold text-gray-500" id="lbl-withdraw">
                                    <input type="radio" name="fiatType" value="withdraw" class="hidden" onchange="app.toggleFiatType('withdraw')"> RÚT
                                </label>
                            </div>
                        </div>
                        <div class="w-1/2">
                            <label class="block text-[10px] text-gray-400 mb-1">Tỷ giá (VND/USDT)</label>
                            <input type="number" id="fiat-rate" step="any" oninput="app.calculateFiatEstimate()" value="25500" class="input-modern w-full rounded-lg px-3 py-2 text-white font-mono text-neon-blue">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-400 mb-1">Số lượng</label>
                        <div class="flex relative">
                            <input type="number" id="fiat-amount" oninput="app.calculateFiatEstimate()" step="any" class="input-modern w-full rounded-l-lg px-3 py-2 text-white font-mono border-r-0">
                            <select id="fiat-unit" onchange="app.calculateFiatEstimate()" class="bg-gray-800 text-white text-xs border border-gray-700 px-3 rounded-r-lg outline-none">
                                <option value="VND">VND</option>
                                <option value="USDT">USDT</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-3 bg-black/40 rounded-lg border border-gray-700 text-center">
                        <div class="text-[10px] text-gray-500 uppercase">Quy đổi ước tính</div>
                        <div class="text-xl font-mono font-bold text-neon-gold" id="fiat-estimate">0.00 USDT</div>
                    </div>
                    <button type="button" onclick="app.saveFiatTransaction()" class="btn-neon btn-neon-blue w-full py-3 rounded-lg font-bold text-sm" id="btn-save-fiat">Xác nhận</button>
                </form>
                
                <form id="form-transfer" class="space-y-4 hidden">
                    <div>
                        <label class="block text-[10px] text-gray-400 mb-1">Tài sản</label>
                        <input type="text" id="transfer-asset" class="input-modern w-full rounded-lg px-3 py-2 text-white uppercase font-bold" placeholder="USDT">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-gray-400 mb-1">Số lượng</label>
                            <div class="relative">
                                <input type="number" id="transfer-amount" step="any" class="input-modern w-full rounded-lg px-3 py-2 text-white font-mono pr-10">
                                <button type="button" onclick="app.setMaxAmount('transfer')" class="absolute right-1 top-1 bottom-1 px-1.5 bg-neon-blue/20 text-neon-blue hover:bg-neon-blue/40 rounded text-[9px] font-bold">MAX</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 mb-1">Phí mạng</label>
                            <input type="number" id="transfer-fee" step="any" class="input-modern w-full rounded-lg px-3 py-2 text-white font-mono" placeholder="0">
                        </div>
                    </div>
                    <button type="button" onclick="app.saveTransferTransaction()" class="btn-neon btn-neon-red w-full py-3 rounded-lg font-bold text-sm" id="btn-save-transfer">Chuyển đi</button>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-di" class="fixed inset-0 bg-black/90 hidden items-end md:items-center justify-center z-[70] backdrop-blur-md">
        <div class="glass-panel w-full max-w-4xl rounded-t-2xl md:rounded-2xl border border-gray-700 overflow-hidden flex flex-col h-[90vh] md:max-h-[90vh]">
            <div class="bg-black/60 px-6 py-4 flex justify-between items-center shrink-0 border-b border-gray-800">
                <h3 class="text-lg font-bold text-white flex items-center gap-2" id="di-modal-title">
                    <i class="fa-solid fa-chart-line text-neon-pink"></i> Tạo Dual Investment
                </h3>
                <button onclick="app.closeModal('di')" class="text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="flex flex-col lg:flex-row h-full overflow-hidden">
                <div class="w-full lg:w-5/12 p-6 space-y-4 overflow-y-auto custom-scrollbar border-b lg:border-b-0 lg:border-r border-gray-800">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] text-neon-blue uppercase mb-1 font-bold">Asset</label>
                            <input type="text" id="di-asset" oninput="app.renderDICalculator()" class="input-modern w-full rounded-lg px-3 py-2 text-white uppercase font-bold" placeholder="BTC">
                            <div id="di-balance-display" class="text-[9px] text-gray-400 mt-1 font-mono text-right">Avail: -</div>
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase mb-1 font-bold">Target Price</label>
                            <input type="number" id="di-target-price" oninput="app.renderDICalculator()" step="any" class="input-modern w-full rounded-lg px-3 py-2 text-white font-mono text-neon-pink">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer border border-gray-700 rounded-lg p-2 hover:bg-white/5 transition relative bg-black/40" id="di-type-high">
                            <input type="radio" name="diType" value="sell_high" checked class="hidden" onchange="app.renderDICalculator()">
                            <div class="font-bold text-red-400 text-xs">Sell High</div>
                            <div class="text-[8px] text-gray-500">Gửi Coin, bán nếu tăng</div>
                            <div class="absolute top-2 right-2 check-icon text-red-500 text-xs"><i class="fa-solid fa-circle-check"></i></div>
                        </label>
                        <label class="cursor-pointer border border-gray-700 rounded-lg p-2 hover:bg-white/5 transition relative opacity-50 bg-black/40" id="di-type-low">
                            <input type="radio" name="diType" value="buy_low" class="hidden" onchange="app.renderDICalculator()">
                            <div class="font-bold text-emerald-400 text-xs">Buy Low</div>
                            <div class="text-[8px] text-gray-500">Gửi USDT, mua nếu giảm</div>
                            <div class="absolute top-2 right-2 check-icon hidden text-emerald-500 text-xs"><i class="fa-solid fa-circle-check"></i></div>
                        </label>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase mb-1">Ngày bắt đầu</label>
                            <input type="date" id="di-start-date" onchange="app.renderDICalculator()" class="input-modern w-full rounded-lg px-2 py-2 text-white text-xs">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase mb-1">Thời hạn (Ngày)</label>
                            <input type="number" id="di-duration" oninput="app.renderDICalculator()" class="input-modern w-full rounded-lg px-2 py-2 text-white text-xs" placeholder="1">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase mb-1">Số lượng</label>
                            <input type="number" id="di-amount" oninput="app.renderDICalculator()" step="any" class="input-modern w-full rounded-lg px-3 py-2 text-white font-bold font-mono">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase mb-1">APR (%)</label>
                            <input type="number" id="di-apr" oninput="app.renderDICalculator()" step="any" class="input-modern w-full rounded-lg px-3 py-2 text-neon-gold font-bold font-mono" placeholder="10">
                        </div>
                    </div>

                    <div class="mt-2 space-y-2">
                        <div class="text-[10px] text-gray-500 font-bold uppercase">Kịch bản:</div>
                        <div class="flex gap-2">
                            <div onclick="app.setDIScenario('below')" id="scen-below" class="neon-option flex-1 p-2 rounded-lg relative transition">
                                <div class="text-[9px] text-gray-400" id="label-below">Giá &lt; Target</div>
                                <div class="text-xs font-bold text-white font-mono" id="val-below-main">...</div>
                            </div>
                            <div onclick="app.setDIScenario('above')" id="scen-above" class="neon-option flex-1 p-2 rounded-lg relative transition">
                                <div class="text-[9px] text-gray-400" id="label-above">Giá &ge; Target</div>
                                <div class="text-xs font-bold text-white font-mono" id="val-above-main">...</div>
                            </div>
                        </div>
                    </div>

                    <button type="button" onclick="app.saveDITransaction()" class="w-full btn-neon btn-neon-pink font-bold py-3 rounded-lg mt-2 text-sm" id="btn-save-di">Xác nhận</button>
                </div>

                <div class="w-full lg:w-7/12 p-6 bg-black/20 flex flex-col">
                    <div class="flex-1 relative w-full h-48 lg:h-auto bg-black/40 rounded-xl border border-gray-800 p-2">
                        <canvas id="diScenarioChart"></canvas>
                        <div id="di-chart-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-600 text-xs">
                            Nhập thông tin để xem biểu đồ
                        </div>
                    </div>
                    <div class="mt-4 bg-gray-900/50 p-4 rounded-lg border border-gray-800 space-y-1">
                        <div class="flex justify-between items-center text-xs text-gray-400">
                            <span>Vốn:</span><span class="text-white font-mono" id="summ-amount-detail">...</span>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-400 border-b border-gray-800 pb-2">
                            <span>Lãi:</span><span class="text-neon-green font-mono" id="summ-interest-detail">...</span>
                        </div>
                        <div class="flex justify-between items-center pt-1">
                            <span class="text-xs text-neon-blue font-bold">NHẬN:</span>
                            <span class="text-lg font-bold text-neon-gold font-mono" id="summ-receive">...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-coin-detail" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[70] backdrop-blur-md">
        <div class="glass-panel w-full max-w-4xl rounded-2xl h-[90vh] flex flex-col border border-gray-700">
            <div class="bg-black/60 px-6 py-4 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold text-white flex items-center gap-2"><img id="detail-coin-icon" class="w-6 h-6 rounded-full"><span id="detail-coin-name">BTC</span></h3>
                <button onclick="app.closeModal('coin-detail')" class="text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-2 border-b border-gray-800 flex gap-2 overflow-x-auto">
                <button onclick="app.setDetailFilter('all')" class="detail-filter-btn text-xs px-3 py-1 rounded bg-neon-blue/20 text-neon-blue">Tất cả</button>
            </div>
            <div class="overflow-y-auto flex-1">
                <table class="w-full text-left"><tbody id="coin-detail-body" class="text-sm divide-y divide-gray-800 text-gray-300"></tbody></table>
            </div>
        </div>
    </div>

    <div id="modal-universal-detail" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[80] backdrop-blur-md">
        <div class="glass-panel w-full max-w-md rounded-2xl border border-gray-700 overflow-hidden m-4">
            <div class="bg-black/60 px-6 py-4 flex justify-between items-center border-b border-gray-800">
                <h3 class="text-lg font-bold text-white">Chi tiết</h3>
                <div class="flex gap-2">
                    <button id="btn-edit-tx" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded text-neon-blue border border-gray-600 transition"><i class="fa-solid fa-pen mr-1"></i> Sửa</button>
                    <button onclick="app.closeModal('universal-detail')" class="text-gray-500 hover:text-white text-xl">&times;</button>
                </div>
            </div>
            <div class="p-6 space-y-4 text-sm" id="universal-detail-content"></div>
        </div>
    </div>

    <div id="modal-trash" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[80] backdrop-blur-md">
        <div class="glass-panel w-full max-w-2xl rounded-2xl border border-gray-700 h-[80vh] flex flex-col m-4">
            <div class="bg-black/60 px-6 py-4 flex justify-between items-center shrink-0 border-b border-gray-800">
                <h3 class="text-lg font-bold text-red-500">Thùng rác</h3>
                <div id="trash-bulk-actions" class="hidden flex gap-2"><button onclick="app.restoreSelectedTrash()" class="text-xs bg-blue-900 px-2 py-1 rounded">Restore</button></div>
                <button onclick="app.toggleTrashModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="overflow-y-auto flex-1 p-4"><table class="w-full text-sm text-gray-400"><tbody id="trash-body"></tbody></table><div id="trash-empty" class="text-center py-8 text-gray-600">Trống</div></div>
        </div>
    </div>

    <div id="modal-quick-action" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[90] backdrop-blur-sm">
        <div class="glass-panel w-80 rounded-2xl p-6 text-center border border-neon-blue/30 shadow-[0_0_30px_rgba(0,240,255,0.2)] relative">
            <button onclick="app.closeModal('quick-action')" class="absolute top-2 right-4 text-gray-500 hover:text-white">&times;</button>
            <div class="mb-6"><img id="qa-icon" src="" class="w-16 h-16 mx-auto rounded-full mb-3 shadow-lg bg-white/10"><h3 class="text-2xl font-bold text-white" id="qa-coin">BTC</h3></div>
            <div class="space-y-3">
                <button onclick="app.quickActionRoute('spot')" class="quick-action-btn w-full py-3 rounded-xl flex items-center justify-center gap-3 text-neon-gold font-bold"><i class="fa-brands fa-bitcoin text-xl"></i> Giao dịch Spot</button>
                <button onclick="app.quickActionRoute('di')" class="quick-action-btn w-full py-3 rounded-xl flex items-center justify-center gap-3 text-neon-pink font-bold"><i class="fa-solid fa-robot text-xl"></i> Dual Investment</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            data: {
                transactions: [],
                snapshots: [], // For Performance Chart
                prices: {},
                selectedHistoryIds: [],
                selectedDIHistoryIds: [],
                selectedTrashIds: [],
                historyPage: 1,
                historyItemsPerPage: 10,
                historyFilterRange: 'all',
                currentDetailCoin: null,
                detailFilterRange: 'all',
                editingId: null, 
                sortOrder: 'desc',
                hideSmallAssets: false,
                isPrivacyMode: false, // New State
                diChartInstance: null,
                perfChartInstance: null, // New Chart Instance
                diPreviewScenario: 'below',
                diPreviewData: null,
                palette: ['#F0B90B', '#00F0FF', '#FF00FF', '#00FF9D', '#FF4D4D', '#8b5cf6', '#06b6d4', '#f97316', '#14b8a6', '#6366f1'],
                quickActionCoin: null,
                tickerInitialized: false
            },

            init() {
                this.loadData();
                this.initDates();
                this.updateMarketData(true); 
                setInterval(() => this.updateMarketData(), 5000); 
            },

            showToast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                let icon = type === 'error' ? '<i class="fa-solid fa-circle-exclamation text-red-500"></i>' : 
                           type === 'success' ? '<i class="fa-solid fa-circle-check text-green-500"></i>' : 
                           '<i class="fa-solid fa-circle-info text-neon-blue"></i>';
                toast.innerHTML = `${icon} <span class="text-sm font-bold flex-1">${msg}</span>`;
                container.appendChild(toast);
                setTimeout(() => { toast.style.animation = 'fadeOut 0.3s ease-out forwards'; setTimeout(() => toast.remove(), 300); }, 3000);
            },

            loadData() {
                const storedTx = localStorage.getItem('crypto_dca_data_v2');
                this.data.transactions = storedTx ? JSON.parse(storedTx) : [];
                
                const storedSnaps = localStorage.getItem('crypto_snapshots_v2');
                this.data.snapshots = storedSnaps ? JSON.parse(storedSnaps) : [];

                const storedPrivacy = localStorage.getItem('isPrivacyMode');
                this.data.isPrivacyMode = storedPrivacy === 'true';
                this.updatePrivacyIcon();
            },

            saveData() {
                localStorage.setItem('crypto_dca_data_v2', JSON.stringify(this.data.transactions));
                localStorage.setItem('crypto_snapshots_v2', JSON.stringify(this.data.snapshots));
                this.renderPortfolio();
                this.renderHistory();
                this.renderTrash();
                this.renderDIView();
                if(this.data.currentDetailCoin) this.renderCoinHistory();
            },

            // --- Privacy Mode Logic ---
            togglePrivacy() {
                this.data.isPrivacyMode = !this.data.isPrivacyMode;
                localStorage.setItem('isPrivacyMode', this.data.isPrivacyMode);
                this.updatePrivacyIcon();
                this.renderPortfolio();
            },
            updatePrivacyIcon() {
                const icon = document.getElementById('privacy-icon');
                if(!icon) return;
                if(this.data.isPrivacyMode) { icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); }
                else { icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); }
            },
            formatMoneyPrivately(val, isCurrency = false) {
                if (this.data.isPrivacyMode) return '******';
                return isCurrency ? `$${this.formatNumber(val, true)}` : this.formatNumber(val);
            },

            // --- Max Button Logic ---
            setMaxAmount(formType) {
                if (formType === 'spot') {
                    const type = document.querySelector('input[name="spotType"]:checked').value;
                    const coin = document.getElementById('spot-coin').value.toUpperCase();
                    if (type === 'buy') {
                        const usdtBal = this.getAssetBalance('USDT');
                        const price = parseFloat(document.getElementById('spot-price').value);
                        if (price > 0) { document.getElementById('spot-amount').value = usdtBal / price; this.calculateSpotLogic('amount'); }
                    } else {
                        const coinBal = this.getAssetBalance(coin);
                        document.getElementById('spot-amount').value = coinBal;
                        this.calculateSpotLogic('amount');
                    }
                } else if (formType === 'transfer') {
                    const asset = document.getElementById('transfer-asset').value.toUpperCase();
                    const bal = this.getAssetBalance(asset);
                    document.getElementById('transfer-amount').value = bal;
                }
            },

            initDates() {
                const vnTime = new Date().toLocaleString("sv-SE", { timeZone: "Asia/Ho_Chi_Minh" }).replace(' ', 'T').slice(0, 16);
                const todayStr = new Date().toLocaleString("sv-SE", { timeZone: "Asia/Ho_Chi_Minh" }).slice(0, 10);
                if(document.getElementById('spot-date')) document.getElementById('spot-date').value = vnTime;
                if(document.getElementById('di-start-date')) document.getElementById('di-start-date').value = todayStr;
            },

            async updateTicker() {
                const container = document.getElementById('top-coins-ticker');
                try {
                    if(!this.data.tickerInitialized) { container.innerHTML = '<span class="text-gray-500 text-xs">Loading...</span>'; }
                    const res = await fetch('https://api.binance.com/api/v3/ticker/24hr');
                    const data = await res.json();
                    const topSymbols = ["BTC","ETH","BNB","SOL","XRP","ADA","DOGE","TRX","AVAX","DOT","LINK","LTC","MATIC"]; 
                    let itemsHtml = '';
                    topSymbols.forEach(sym => {
                        const info = data.find(i => i.symbol === sym + 'USDT');
                        if(info) {
                            const price = parseFloat(info.lastPrice);
                            const change = parseFloat(info.priceChangePercent);
                            const color = change >= 0 ? 'text-neon-green' : 'text-neon-red';
                            const icon = change >= 0 ? 'fa-caret-up' : 'fa-caret-down';
                            itemsHtml += `
                                <div onclick="app.openQuickAction('${sym}')" class="inline-flex flex-col items-center justify-center px-4 md:px-6 border-r border-white/10 cursor-pointer hover:bg-white/5 transition group min-w-[80px] md:min-w-[100px]">
                                    <div class="flex items-center gap-1">
                                        <img src="${this.getCoinIcon(sym)}" class="w-3 h-3 rounded-full opacity-70 group-hover:opacity-100">
                                        <span class="font-bold text-white text-[10px] md:text-xs group-hover:text-neon-blue transition">${sym}</span>
                                    </div>
                                    <div class="flex gap-2 items-center">
                                        <span class="text-gray-300 text-[10px] md:text-xs font-mono">$${this.formatNumber(price, price < 1)}</span>
                                        <span class="${color} text-[8px] md:text-[10px] flex items-center gap-0.5 font-bold"><i class="fa-solid ${icon}"></i> ${Math.abs(change).toFixed(2)}%</span>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    container.innerHTML = `<div class="ticker-wrap"><div class="ticker-content">${itemsHtml} ${itemsHtml}</div></div>`;
                    this.data.tickerInitialized = true;
                } catch(e) { if(!this.data.tickerInitialized) container.innerHTML = `<span class="text-red-500 text-xs px-4">Offline</span>`; }
            },

            openQuickAction(coin) {
                this.data.quickActionCoin = coin;
                document.getElementById('qa-coin').innerText = coin;
                document.getElementById('qa-icon').src = this.getCoinIcon(coin);
                document.getElementById('modal-quick-action').classList.remove('hidden');
                document.getElementById('modal-quick-action').classList.add('flex');
            },

            quickActionRoute(type) {
                const coin = this.data.quickActionCoin;
                this.closeModal('quick-action');
                if (type === 'spot') {
                    this.openAddTransactionModal();
                    setTimeout(() => { document.getElementById('spot-coin').value = coin; this.onSpotCoinInput(coin); this.fetchSpotPriceInModal(); }, 100);
                } else if (type === 'di') {
                    this.openDIModal();
                    setTimeout(() => { document.getElementById('di-asset').value = coin; const price = this.getRate(coin); if(price) document.getElementById('di-target-price').placeholder = `Hiện tại: ${price}`; }, 100);
                }
            },

            exportData() {
                const dataStr = JSON.stringify({ transactions: this.data.transactions, snapshots: this.data.snapshots });
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `neon_portfolio_backup_${new Date().toISOString().slice(0,10)}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                this.showToast('Đã tải xuống file sao lưu!', 'success');
            },

            importData(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json.transactions || Array.isArray(json)) {
                            if(confirm(`Khôi phục dữ liệu?`)) {
                                this.data.transactions = json.transactions || json;
                                if(json.snapshots) this.data.snapshots = json.snapshots;
                                this.saveData();
                                this.showToast('Khôi phục thành công!', 'success');
                                setTimeout(() => location.reload(), 1000);
                            }
                        } else { this.showToast('File không hợp lệ!', 'error'); }
                    } catch (err) { this.showToast('Lỗi đọc file JSON!', 'error'); }
                };
                reader.readAsText(file);
                input.value = '';
            },

            async updateMarketData(initial = false) {
                await this.fetchPrices();
                await this.updateTicker();
                this.renderPortfolio();
                this.renderDIView();
                if (initial) this.renderHistory();
            },

            async fetchPrices() {
                try {
                    const binanceRes = await fetch('https://api.binance.com/api/v3/ticker/price');
                    const binanceData = await binanceRes.json();
                    binanceData.forEach(item => this.data.prices[item.symbol] = parseFloat(item.price));
                    this.data.prices['USDTUSDT'] = 1;
                } catch (e) {
                    this.data.prices = { 'BTCUSDT': 98500.00, 'ETHUSDT': 3850.00, 'BNBUSDT': 650.00, 'SOLUSDT': 245.00, 'XRPUSDT': 2.45, 'ADAUSDT': 1.15, 'DOGEUSDT': 0.35, 'TRXUSDT': 0.25, 'AVAXUSDT': 45.00, 'DOTUSDT': 8.50, 'USDTUSDT': 1.00 };
                }
            },

            getRate(symbol) { return symbol === 'USDT' ? 1 : (this.data.prices[symbol + 'USDT'] || 0); },
            getCoinIcon(symbol) { if(!symbol) return ''; return `https://raw.githubusercontent.com/spothq/cryptocurrency-icons/master/128/color/${symbol.toLowerCase()}.png`; },
            handleImgError(img) { img.onerror = null; img.src = 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Anonymous_emblem.svg/1200px-Anonymous_emblem.svg.png'; img.style.filter = 'grayscale(100%) opacity(0.5)'; },
            formatNumber(num, isCurrency = false) {
                if (num === undefined || num === null || isNaN(parseFloat(num))) return '0';
                num = parseFloat(num);
                if(isCurrency) return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                if (Math.abs(num) >= 1) return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 4 });
                return num === 0 ? '0.00' : num.toFixed(6);
            },

            calculatePortfolio() {
                const assets = {};
                let usdtBalance = 0; let totalInvestedUSDT = 0; let realizedPnL = 0;
                const activeTx = this.data.transactions.filter(t => !t.deleted);
                activeTx.sort((a, b) => new Date(a.date) - new Date(b.date));

                activeTx.forEach(tx => {
                    const amt = parseFloat(tx.amount) || 0;
                    const total = parseFloat(tx.total) || 0;
                    const fee = parseFloat(tx.fee) || 0;
                    if (tx.type === 'deposit') { usdtBalance += amt; totalInvestedUSDT += amt; }
                    else if (tx.type === 'withdraw') { usdtBalance -= amt; totalInvestedUSDT -= amt; }
                    else if (tx.type === 'buy') {
                        if (!assets[tx.coin]) assets[tx.coin] = { amount: 0, locked: 0, totalCost: 0 };
                        const netAmount = amt - fee;
                        assets[tx.coin].amount += netAmount;
                        assets[tx.coin].totalCost += total;
                        usdtBalance -= total;
                    } else if (tx.type === 'sell') {
                        if (assets[tx.coin]) {
                            const avgPrice = assets[tx.coin].totalCost / (assets[tx.coin].amount + assets[tx.coin].locked);
                            const profit = (tx.price - avgPrice) * amt;
                            realizedPnL += profit;
                            assets[tx.coin].amount -= amt;
                            assets[tx.coin].totalCost -= (amt * avgPrice);
                            usdtBalance += total;
                        }
                    } else if (tx.type === 'transfer') {
                        if (tx.coin === 'USDT') { usdtBalance -= (amt + fee); }
                        else if (assets[tx.coin]) { assets[tx.coin].amount -= (amt + fee); }
                    } else if (tx.type === 'di_entry') {
                        if (tx.diType === 'sell_high') {
                            if (!assets[tx.coin]) assets[tx.coin] = { amount: 0, locked: 0, totalCost: 0 };
                            assets[tx.coin].amount -= amt;
                            assets[tx.coin].locked += amt;
                        } else {
                            usdtBalance -= amt;
                            if (!assets['USDT']) assets['USDT'] = { amount: 0, locked: 0, totalCost: 0 };
                            assets['USDT'].locked += amt;
                        }
                    } else if (tx.type === 'di_settle') {
                        const resAmt = parseFloat(tx.resultAmount) || 0;
                        const parent = this.data.transactions.find(p => p.id === tx.parentDiId);
                        if(parent) {
                            if(parent.diType === 'sell_high') {
                                assets[parent.coin].locked -= parent.amount;
                                if(tx.resultAsset === 'USDT') {
                                    const avgPrice = assets[parent.coin].totalCost / (assets[parent.coin].amount + parent.amount);
                                    const costOfPrincipal = parent.amount * avgPrice;
                                    realizedPnL += (resAmt - costOfPrincipal);
                                    assets[parent.coin].totalCost -= costOfPrincipal;
                                    usdtBalance += resAmt;
                                } else { assets[parent.coin].amount += resAmt; }
                            } else {
                                if (assets['USDT']) assets['USDT'].locked -= parent.amount;
                                if (tx.resultAsset === 'USDT') {
                                    const interestUSDT = resAmt - parent.amount;
                                    realizedPnL += interestUSDT;
                                    usdtBalance += resAmt;
                                } else {
                                    if (!assets[tx.resultAsset]) assets[tx.resultAsset] = { amount: 0, locked: 0, totalCost: 0 };
                                    assets[tx.resultAsset].amount += resAmt;
                                    assets[tx.resultAsset].totalCost += parent.amount;
                                }
                            }
                        }
                    }
                });
                return { assets, usdtBalance, totalInvestedUSDT, realizedPnL };
            },

            // --- Performance Snapshot Logic ---
            checkAndSaveDailySnapshot(totalValue) {
                if(totalValue <= 0) return;
                const today = new Date().toISOString().slice(0, 10);
                const existing = this.data.snapshots.find(s => s.date === today);
                if (!existing) {
                    this.data.snapshots.push({ date: today, value: totalValue });
                    // Keep only last 30 days to avoid huge array
                    if(this.data.snapshots.length > 30) this.data.snapshots.shift();
                    localStorage.setItem('crypto_snapshots_v2', JSON.stringify(this.data.snapshots));
                } else {
                    // Optional: Update today's value if it changed significantly? 
                    // For now, let's keep the first snapshot of the day or overwrite it
                    existing.value = totalValue;
                    localStorage.setItem('crypto_snapshots_v2', JSON.stringify(this.data.snapshots));
                }
            },

            renderPerformanceChart() {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                if (this.perfChartInstance) this.perfChartInstance.destroy();
                
                // If not enough data, show placeholder
                if (this.data.snapshots.length < 2) {
                    document.getElementById('perf-chart-empty').classList.remove('hidden');
                    return;
                }
                document.getElementById('perf-chart-empty').classList.add('hidden');

                const labels = this.data.snapshots.map(s => s.date.slice(5)); // MM-DD
                const values = this.data.snapshots.map(s => s.value);

                this.perfChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Asset Value',
                            data: values,
                            borderColor: '#00FF9D',
                            backgroundColor: 'rgba(0, 255, 157, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3,
                            pointBackgroundColor: '#050505',
                            pointBorderColor: '#00FF9D'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#666', font: { size: 10 } } },
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666', font: { size: 10 }, callback: (val) => '$' + val/1000 + 'k' } }
                        }
                    }
                });
            },

            toggleSmallAssets() { this.data.hideSmallAssets = document.getElementById('hide-small-assets').checked; this.renderPortfolio(); },
            
            renderPortfolio() {
                const { assets, usdtBalance, totalInvestedUSDT, realizedPnL } = this.calculatePortfolio();
                const tbody = document.getElementById('assets-table-body');
                tbody.innerHTML = '';
                
                document.getElementById('usdt-available').innerText = this.formatNumber(usdtBalance, true);

                let totalLockedUSDT = assets['USDT'] ? assets['USDT'].locked : 0;
                let totalPortfolioValue = usdtBalance + totalLockedUSDT;
                let totalCostBasis = totalLockedUSDT + usdtBalance;
                
                const chartLabels = ['USDT']; const chartData = [usdtBalance + totalLockedUSDT]; const chartColors = ['#0ECB81'];
                
                // Render USDT Row
                const trUSDT = document.createElement('tr');
                trUSDT.className = "border-b border-gray-800 hover:bg-white/5 transition cursor-pointer";
                trUSDT.onclick = () => this.openCoinDetail('USDT');
                trUSDT.innerHTML = `<td class="py-4 px-2 flex items-center gap-3"><img src="${this.getCoinIcon('USDT')}" class="w-6 h-6 md:w-8 md:h-8 rounded-full shadow-md"><div><div class="font-bold text-white text-xs md:text-sm">USDT</div><div class="text-[9px] text-gray-500 font-mono tracking-wider">Tether</div></div></td><td class="py-4 px-2 text-right font-mono text-white text-xs md:text-sm">${this.formatNumber(usdtBalance)}${totalLockedUSDT > 0 ? `<br><span class="text-[9px] text-neon-gold"><i class="fa-solid fa-lock"></i> ${this.formatNumber(totalLockedUSDT)}</span>` : ''}</td><td class="py-4 px-2 text-right text-gray-500 font-mono text-xs md:text-sm hide-on-mobile">1.00</td><td class="py-4 px-2 text-right text-gray-500 font-mono text-xs md:text-sm">1.00</td><td class="py-4 px-2 text-right font-bold font-mono text-white shadow-neon text-xs md:text-sm">${this.formatMoneyPrivately(usdtBalance + totalLockedUSDT, true)}</td><td class="py-4 px-2 text-right text-xs md:text-sm text-gray-600">-</td>`;
                tbody.appendChild(trUSDT);

                let colorIdx = 0;
                Object.keys(assets).forEach(coin => {
                    if (coin === 'USDT') return;
                    const data = assets[coin];
                    const totalAmount = data.amount + data.locked;
                    if (totalAmount <= 0.00000001) return;
                    const currentPrice = this.getRate(coin);
                    const value = totalAmount * currentPrice;
                    totalPortfolioValue += value;
                    totalCostBasis += data.totalCost;
                    
                    if(value > 1) { chartLabels.push(coin); chartData.push(value); chartColors.push(this.data.palette[colorIdx++ % this.data.palette.length]); }
                    
                    const avgPrice = data.totalCost / totalAmount;
                    const pnlVal = value - data.totalCost;
                    const pnlPct = data.totalCost > 0 ? (pnlVal / data.totalCost * 100) : 0;
                    if(this.data.hideSmallAssets && value < 1) return;
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-800 hover:bg-white/5 transition group cursor-pointer";
                    tr.onclick = () => this.openCoinDetail(coin);
                    tr.innerHTML = `<td class="py-4 px-2 flex items-center gap-3 group-hover:text-neon-blue transition"><img src="${this.getCoinIcon(coin)}" onerror="app.handleImgError(this)" class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-white/10"><span class="font-bold text-xs md:text-lg">${coin}</span></td><td class="py-4 px-2 text-right font-mono text-white text-xs md:text-sm">${this.formatNumber(data.amount)}${data.locked > 0 ? `<br><span class="text-[9px] text-neon-gold"><i class="fa-solid fa-lock"></i> ${this.formatNumber(data.locked)}</span>` : ''}</td><td class="py-4 px-2 text-right text-gray-400 font-mono text-xs md:text-sm hide-on-mobile">${this.formatNumber(avgPrice)}</td><td class="py-4 px-2 text-right text-neon-blue font-mono text-xs md:text-sm shadow-blue-sm">${this.formatNumber(currentPrice)}</td><td class="py-4 px-2 text-right font-bold text-white font-mono text-xs md:text-sm">${this.formatMoneyPrivately(value, true)}</td><td class="py-4 px-2 text-right font-mono font-bold text-xs md:text-sm ${pnlVal >= 0 ? 'text-neon-green drop-shadow-[0_0_5px_rgba(0,255,157,0.4)]' : 'text-neon-red drop-shadow-[0_0_5px_rgba(255,77,77,0.4)]'}">${pnlVal >= 0 ? '+' : ''}${this.formatMoneyPrivately(pnlVal, true)}<br><span class="text-[9px] opacity-80">(${pnlPct.toFixed(2)}%)</span></td>`;
                    tbody.appendChild(tr);
                });

                document.getElementById('total-balance').innerText = this.formatMoneyPrivately(totalPortfolioValue, true);
                document.getElementById('total-invested').innerText = this.formatMoneyPrivately(totalInvestedUSDT, true);
                
                const unrealizedPnLTotal = totalPortfolioValue - totalCostBasis;
                const unrealizedPct = totalCostBasis > 0 ? (unrealizedPnLTotal / totalCostBasis * 100) : 0;

                const uPnlEl = document.getElementById('unrealized-pnl');
                uPnlEl.innerText = `${unrealizedPnLTotal >= 0 ? '+' : ''}${this.formatMoneyPrivately(unrealizedPnLTotal, true)}`;
                uPnlEl.className = `text-xl md:text-3xl font-bold font-mono ${unrealizedPnLTotal >= 0 ? 'text-neon-green' : 'text-neon-red'}`;
                document.getElementById('unrealized-pnl-pct').innerText = `${unrealizedPct.toFixed(2)}%`;
                document.getElementById('unrealized-pnl-pct').className = `text-xs md:text-lg font-bold mt-1 ${unrealizedPnLTotal >= 0 ? 'text-emerald-400' : 'text-red-400'}`;

                const rPnlEl = document.getElementById('realized-pnl');
                rPnlEl.innerText = `${realizedPnL >= 0 ? '+' : ''}${this.formatMoneyPrivately(realizedPnL, true)}`;
                rPnlEl.className = `text-xl md:text-3xl font-bold font-mono ${realizedPnL >= 0 ? 'text-neon-pink' : 'text-neon-red'}`;
                
                this.renderChart(chartLabels, chartData, chartColors, totalPortfolioValue);
                this.checkAndSaveDailySnapshot(totalPortfolioValue);
                this.renderPerformanceChart();
            },

            // ... Keep existing RenderHistory, RenderDI, etc. ...
            renderHistory() {
                const tbody = document.getElementById('history-table-body');
                tbody.innerHTML = '';
                const typeFilter = document.getElementById('filter-type').value;
                const pairFilter = document.getElementById('filter-pair').value.toUpperCase().trim();
                let filtered = this.data.transactions.filter(t => !t.deleted && !t.type.includes('di'));
                if (typeFilter !== 'all') {
                    if (typeFilter === 'buy_usdt') filtered = filtered.filter(t => t.type === 'buy');
                    else if (typeFilter === 'sell_usdt') filtered = filtered.filter(t => t.type === 'sell');
                    else if (typeFilter === 'fiat_usdt') filtered = filtered.filter(t => t.type === 'deposit' || t.type === 'withdraw');
                    else if (typeFilter === 'transfer') filtered = filtered.filter(t => t.type === 'transfer');
                }
                if (pairFilter) { filtered = filtered.filter(t => { let txt = t.coin ? t.coin : 'USDT'; return txt.includes(pairFilter); }); }
                filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                // Only show 50 most recent for performance
                filtered.slice(0, 50).forEach(t => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 transition border-b border-gray-800 clickable-row " + (this.data.selectedHistoryIds.includes(t.id) ? "bg-white/10" : "");
                    tr.onclick = (e) => { if(e.target.type !== 'checkbox' && !e.target.closest('button')) { app.openUniversalDetail(t.id); } };
                    let typeHtml='', details='', price='', amount='', totalVal='';
                    if (t.type === 'buy') { typeHtml = '<span class="text-neon-green font-bold text-[10px] border border-neon-green/30 px-1 rounded">BUY</span>'; details = `${t.coin}`; amount = `<span class="text-neon-green">+${this.formatNumber(t.amount - t.fee)}</span>`; price = t.price; totalVal = `<span class="text-gray-400">-${this.formatNumber(t.total)}</span>`; }
                    else if (t.type === 'sell') { typeHtml = '<span class="text-neon-red font-bold text-[10px] border border-neon-red/30 px-1 rounded">SELL</span>'; details = `${t.coin}`; amount = `<span class="text-neon-red">-${this.formatNumber(t.amount + t.fee)}</span>`; price = t.price; totalVal = `<span class="text-neon-gold">+${this.formatNumber(t.total)}</span>`; }
                    else if (t.type === 'deposit') { typeHtml = '<span class="text-neon-blue font-bold text-[10px] border border-neon-blue/30 px-1 rounded">DEP</span>'; details = 'USDT'; amount = `+${this.formatNumber(t.amount)}`; price = t.rate; totalVal = `<span class="text-neon-blue">$${this.formatNumber(t.amount)}</span>`; }
                    else if (t.type === 'withdraw') { typeHtml = '<span class="text-gray-400 font-bold text-[10px] border border-gray-600 px-1 rounded">WTH</span>'; details = 'USDT'; amount = `-${this.formatNumber(t.amount)}`; price = t.rate; totalVal = `<span class="text-gray-500">$${this.formatNumber(t.amount)}</span>`; }
                    else if (t.type === 'transfer') { typeHtml = '<span class="text-orange-400 font-bold text-[10px] border border-orange-400 px-1 rounded">TRF</span>'; details = `${t.coin}`; amount = `-${this.formatNumber(t.amount)}`; totalVal = `<span class="text-red-400">Fee ${this.formatNumber(t.fee)}</span>`; }
                    
                    const actionButtons = `<button onclick="app.softDeleteTransaction('${t.id}', event)" class="text-gray-600 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>`;
                    tr.innerHTML = `<td class="p-3 text-center"><input type="checkbox" onclick="app.toggleHistorySelection('${t.id}')" ${this.data.selectedHistoryIds.includes(t.id) ? 'checked' : ''}></td><td class="p-3 text-gray-500 text-[10px] font-mono whitespace-nowrap">${t.date.slice(5,10)}</td><td class="p-3">${typeHtml}</td><td class="p-3 font-bold text-xs">${details}</td><td class="p-3 text-right font-mono text-xs text-gray-400">${this.formatNumber(price)}</td><td class="p-3 text-right font-mono font-bold text-xs">${amount}</td><td class="p-3 text-right font-mono font-bold text-xs">${totalVal}</td><td class="p-3 text-center">${actionButtons}</td>`;
                    tbody.appendChild(tr);
                });
            },

            // Keeping other render functions from previous version, just ensuring responsive adjustments
            toggleSort() { this.data.sortOrder = this.data.sortOrder === 'desc' ? 'asc' : 'desc'; this.renderHistory(); this.renderDIView(); if(this.data.currentDetailCoin) this.renderCoinHistory(); },
            openUniversalDetail(id) {
                const tx = this.data.transactions.find(t => t.id === id);
                if(!tx) return;
                let content = '';
                if (tx.type === 'di_settle') { const p = this.data.transactions.find(x => x.id === tx.parentDiId); content = this.generateDIDetailHTML(p, tx); }
                else if (tx.type === 'di_entry') { const settledTx = this.data.transactions.find(x => x.parentDiId === tx.id && !x.deleted); content = this.generateDIDetailHTML(tx, settledTx); }
                else {
                    content = `<div class="space-y-3"><div class="flex justify-between border-b border-gray-700 pb-2"><span class="text-gray-400">Loại:</span> <span class="font-bold text-white uppercase">${tx.type}</span></div><div class="flex justify-between"><span class="text-gray-400">Ngày:</span> <span class="text-white font-mono">${new Date(tx.date).toLocaleString()}</span></div>${tx.coin ? `<div class="flex justify-between"><span class="text-gray-400">Coin:</span> <span class="text-neon-gold font-bold">${tx.coin}</span></div>` : ''}${tx.price ? `<div class="flex justify-between"><span class="text-gray-400">Giá:</span> <span class="text-white font-mono">${this.formatNumber(tx.price)}</span></div>` : ''}<div class="flex justify-between"><span class="text-gray-400">Số lượng:</span> <span class="text-white font-mono">${this.formatNumber(tx.amount)}</span></div>${tx.fee ? `<div class="flex justify-between"><span class="text-gray-400">Phí:</span> <span class="text-red-400 font-mono">${this.formatNumber(tx.fee)} ${tx.feeCoin||tx.coin}</span></div>` : ''}${tx.total ? `<div class="flex justify-between border-t border-gray-700 pt-2"><span class="text-gray-400">Tổng USDT:</span> <span class="text-neon-green font-bold font-mono">${this.formatNumber(tx.total)}</span></div>` : ''}${tx.rate ? `<div class="flex justify-between"><span class="text-gray-400">Tỷ giá:</span> <span class="text-white font-mono">${this.formatNumber(tx.rate)}</span></div>` : ''}</div>`;
                }
                if(tx.type === 'di_settle') document.getElementById('btn-edit-tx').style.display = 'none';
                else document.getElementById('btn-edit-tx').style.display = 'block';

                document.getElementById('universal-detail-content').innerHTML = content;
                document.getElementById('btn-edit-tx').onclick = (e) => app.editTransaction(id, e); 
                document.getElementById('modal-universal-detail').classList.remove('hidden'); document.getElementById('modal-universal-detail').classList.add('flex');
            },
            
            generateDIDetailHTML(parentTx, settleTx) {
                if(!parentTx) return '<div>Dữ liệu gốc không tồn tại</div>';
                const start = new Date(parentTx.date); const end = new Date(parentTx.endDate); const days = Math.max(1, Math.ceil((end-start)/(1000*60*60*24)));
                let html = `<div class="border-b border-gray-700 pb-3 mb-3"><div class="text-xs text-gray-500 uppercase mb-2">Thông tin đăng ký (Entry)</div><div class="grid grid-cols-2 gap-2"><div><span class="text-gray-400 text-xs">Loại:</span> <div class="font-bold ${parentTx.diType==='sell_high'?'text-red-400':'text-emerald-400'}">${parentTx.diType==='sell_high'?'SELL HIGH':'BUY LOW'}</div></div><div><span class="text-gray-400 text-xs">Tài sản:</span> <div class="text-white font-bold">${parentTx.coin}</div></div><div><span class="text-gray-400 text-xs">Target:</span> <div class="text-neon-pink font-mono">${parentTx.targetPrice}</div></div><div><span class="text-gray-400 text-xs">Gốc Lock:</span> <div class="text-white font-mono">${this.formatNumber(parentTx.amount)}</div></div><div><span class="text-gray-400 text-xs">APR:</span> <div class="text-neon-gold font-mono">${parentTx.apr}%</div></div><div><span class="text-gray-400 text-xs">Thời hạn:</span> <div class="text-white">${days} ngày</div></div></div></div>`;
                if (settleTx) { html += `<div><div class="text-xs text-gray-500 uppercase mb-2">Kết quả (Settled)</div><div class="flex justify-between mb-1"><span class="text-gray-400">Ngày về:</span> <span class="text-white font-mono text-xs">${new Date(settleTx.date).toLocaleDateString()}</span></div><div class="flex justify-between mb-1"><span class="text-gray-400">Nhận:</span> <span class="text-neon-green font-bold font-mono">+${this.formatNumber(settleTx.resultAmount)} ${settleTx.resultAsset}</span></div><div class="flex justify-between"><span class="text-gray-400">Giá trị USDT:</span> <span class="text-gray-300 font-mono text-xs">≈ $${this.formatNumber(settleTx.settlementValueUSDT, true)}</span></div></div>`; }
                else { html += `<div class="text-center text-neon-blue text-xs italic border-t border-gray-700 pt-2">Đang hoạt động (Active)</div>`; }
                return html;
            },
            
            editTransaction(id, e) {
                if (e) e.stopPropagation();
                this.closeModal('universal-detail');
                const tx = this.data.transactions.find(t => t.id === id);
                if(!tx) return;
                
                if (tx.type.includes('settle')) {
                    this.showToast("Không thể sửa giao dịch đã tất toán (Settle).", 'error');
                    return;
                }

                this.data.editingId = id;
                if(document.getElementById('modal-title')) document.getElementById('modal-title').innerText = "CẬP NHẬT GIAO DỊCH";
                if(document.getElementById('btn-save-spot')) document.getElementById('btn-save-spot').innerText = "Lưu Thay Đổi";
                if(document.getElementById('btn-save-fiat')) document.getElementById('btn-save-fiat').innerText = "Lưu Thay Đổi";
                if(document.getElementById('btn-save-transfer')) document.getElementById('btn-save-transfer').innerText = "Lưu Thay Đổi";
                if(document.getElementById('di-modal-title')) document.getElementById('di-modal-title').innerHTML = '<i class="fa-solid fa-chart-line text-neon-pink"></i> Cập nhật Dual Investment';
                if(document.getElementById('btn-save-di')) document.getElementById('btn-save-di').innerText = "Lưu Thay Đổi";

                if (tx.type === 'buy' || tx.type === 'sell') {
                    this.switchModalTab('spot');
                    document.querySelector(`input[name="spotType"][value="${tx.type}"]`).checked = true;
                    this.toggleSpotType(tx.type);
                    document.getElementById('spot-date').value = tx.date.slice(0,16);
                    document.getElementById('spot-coin').value = tx.coin;
                    document.getElementById('spot-price').value = tx.price;
                    document.getElementById('spot-amount').value = tx.amount;
                    document.getElementById('spot-total').value = tx.total;
                    document.getElementById('spot-fee').value = tx.fee || 0;
                    this.onSpotCoinInput(tx.coin);
                    this.showTransactionModal(); 
                } else if (tx.type === 'transfer') {
                    this.switchModalTab('transfer');
                    document.getElementById('transfer-asset').value = tx.coin;
                    document.getElementById('transfer-amount').value = tx.amount;
                    document.getElementById('transfer-fee').value = tx.fee;
                    this.showTransactionModal(); 
                } else if (tx.type === 'deposit' || tx.type === 'withdraw') {
                    this.switchModalTab('fiat');
                    document.querySelector(`input[name="fiatType"][value="${tx.type}"]`).checked = true;
                    this.toggleFiatType(tx.type);
                    document.getElementById('fiat-rate').value = tx.rate;
                    document.getElementById('fiat-amount').value = tx.amount;
                    document.getElementById('fiat-unit').value = 'USDT'; 
                    this.calculateFiatEstimate();
                    this.showTransactionModal(); 
                } else if (tx.type === 'di_entry') {
                    document.getElementById('di-asset').value = tx.coin;
                    document.getElementById('di-target-price').value = tx.targetPrice;
                    document.getElementById('di-amount').value = tx.amount;
                    document.getElementById('di-apr').value = tx.apr;
                    document.getElementById('di-start-date').value = tx.date;
                    const start = new Date(tx.date);
                    const end = new Date(tx.endDate);
                    const duration = Math.ceil((end - start) / 86400000);
                    document.getElementById('di-duration').value = duration;
                    document.querySelector(`input[name="diType"][value="${tx.diType}"]`).checked = true;
                    this.renderDICalculator();
                    document.getElementById('modal-di').classList.remove('hidden'); 
                    document.getElementById('modal-di').classList.add('flex');
                    this.updateDIBalanceDisplay();
                }
            },
            
            renderDIView() {
                const listActive = document.getElementById('di-list-active'); const listHistory = document.getElementById('di-list-history'); listActive.innerHTML = ''; listHistory.innerHTML = '';
                let activeDIs = this.data.transactions.filter(t => t.type === 'di_entry' && !t.deleted && !t.settled);
                activeDIs.sort((a, b) => { const dateA = new Date(a.date), dateB = new Date(b.date); return this.data.sortOrder === 'desc' ? dateB - dateA : dateA - dateB; });
                if(activeDIs.length === 0) listActive.innerHTML = '<div class="text-center text-gray-500 py-8 border border-dashed border-gray-800 rounded-lg text-xs">Chưa có gói hoạt động</div>';
                else activeDIs.forEach(di => {
                    const daysLeft = Math.ceil((new Date(di.endDate) - new Date()) / 86400000);
                    const currentPrice = this.getRate(di.coin);
                    const dist = currentPrice > 0 ? ((currentPrice - di.targetPrice)/di.targetPrice*100).toFixed(2) : 0;
                    const colorDist = dist >= 0 ? 'text-neon-green' : 'text-neon-red';
                    const div = document.createElement('div');
                    div.className = `glass-panel p-4 md:p-5 rounded-xl border-l-4 ${di.diType === 'sell_high' ? 'border-red-500' : 'border-emerald-500'} hover:bg-white/5 transition cursor-pointer relative group`;
                    div.onclick = (e) => { if(!e.target.closest('button')) app.openUniversalDetail(di.id); };
                    div.innerHTML = `<div class="absolute top-2 right-2 z-10"><button onclick="app.editTransaction('${di.id}', event)" class="text-neon-blue p-1 mr-1"><i class="fa-solid fa-pen"></i></button><button onclick="app.softDeleteTransaction('${di.id}', event)" class="text-gray-500 hover:text-red-500 p-1"><i class="fa-solid fa-trash"></i></button></div><div class="flex justify-between mb-3"><span class="bg-black/50 text-[10px] px-2 py-1 rounded text-white font-bold border border-gray-700">${di.diType === 'sell_high' ? 'SELL HIGH' : 'BUY LOW'}</span><span class="font-bold text-white text-sm md:text-lg flex items-center gap-2"><img src="${this.getCoinIcon(di.coin)}" class="w-4 h-4 md:w-5 md:h-5 rounded-full">${di.coin}</span></div><div class="grid grid-cols-2 gap-2 text-[10px] md:text-xs text-gray-400 mb-3"><div class="flex flex-col"><span>Target</span><b class="text-white">${di.targetPrice}</b></div><div class="flex flex-col text-right"><span>Current</span><b class="text-white">${this.formatNumber(currentPrice)} <span class="${colorDist} text-[8px]">(${dist}%)</span></b></div><div class="flex flex-col"><span>Lock</span><b class="text-white">${this.formatNumber(di.amount)}</b></div><div class="flex flex-col text-right"><span>APR</span><b class="text-neon-gold">${di.apr}%</b></div></div><div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-800"><span class="text-[9px] text-neon-blue font-bold"><i class="fa-regular fa-clock"></i> ${daysLeft}d</span><div class="flex gap-2"><button onclick="app.settleDI('${di.id}', false, event)" class="text-[9px] bg-gray-800 px-2 py-1 rounded text-gray-300">Fail</button><button onclick="app.settleDI('${di.id}', true, event)" class="text-[9px] bg-neon-gold/20 text-neon-gold font-bold px-2 py-1 rounded border border-neon-gold/50">Win</button></div></div>`;
                    listActive.appendChild(div);
                });
                let diHistory = this.data.transactions.filter(t => (t.type === 'di_settle' || t.type === 'di_entry') && !t.deleted);
                diHistory = diHistory.filter(t => !(t.type === 'di_entry' && !t.settled));
                diHistory.sort((a,b) => { const dateA = new Date(a.date), dateB = new Date(b.date); return this.data.sortOrder === 'desc' ? dateB - dateA : dateA - dateB; });
                let totalProfit = 0;
                diHistory.forEach(t => {
                    if(t.type === 'di_settle') {
                        const p = this.data.transactions.find(x => x.id === t.parentDiId);
                        if(p) {
                            let interestVal = 0;
                            if(t.resultAsset === 'USDT') {
                                if(p.diType === 'sell_high') interestVal = t.resultAmount - (p.amount * p.targetPrice);
                                else interestVal = t.resultAmount - p.amount;
                            } else {
                                if(p.diType === 'sell_high') interestVal = (t.resultAmount - p.amount) * (this.getRate(p.coin) || p.targetPrice);
                                else interestVal = (t.resultAmount - (p.amount/p.targetPrice)) * (this.getRate(p.coin) || p.targetPrice);
                            }
                            if(interestVal > 0) totalProfit += interestVal;
                        }
                    }
                });
                document.getElementById('di-total-rewards').innerText = `$${this.formatNumber(totalProfit, true)}`;
                const bulkActions = document.getElementById('di-bulk-actions');
                if(this.data.selectedDIHistoryIds.length > 0) { bulkActions.classList.remove('hidden'); document.getElementById('di-selected-count').innerText = this.data.selectedDIHistoryIds.length; } else bulkActions.classList.add('hidden');
                diHistory.slice(0, 30).forEach(s => { // Limit render
                    const p = s.type === 'di_settle' ? this.data.transactions.find(x => x.id === s.parentDiId) : s;
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-800 hover:bg-white/5 transition clickable-row " + (this.data.selectedDIHistoryIds.includes(s.id) ? "bg-white/10" : "");
                    tr.onclick = (e) => { if(!e.target.type !== 'checkbox' && !e.target.closest('button') && !e.target.closest('input')) app.openUniversalDetail(s.id); };
                    let typeBadge = s.type === 'di_settle' ? '<span class="text-neon-green text-[9px] border border-neon-green px-1 rounded">SETTLE</span>' : '<span class="text-gray-500 text-[9px] border border-gray-600 px-1 rounded">ENTRY</span>';
                    let asset = p ? p.coin : '?';
                    let val = s.type === 'di_settle' ? `+${this.formatNumber(s.resultAmount)}` : `${this.formatNumber(s.amount)}`;
                    let valColor = s.type === 'di_settle' ? 'text-neon-green' : 'text-gray-400';
                    tr.innerHTML = `<td class="p-3 text-center"><input type="checkbox" onclick="app.toggleDIHistorySelection('${s.id}', event)" class="accent-neon-pink cursor-pointer" ${this.data.selectedDIHistoryIds.includes(s.id) ? 'checked' : ''}></td><td class="p-3 text-xs text-gray-500 font-mono">${s.date.slice(5,10)}</td><td class="p-3 font-bold text-white text-xs">${asset}</td><td class="p-3">${typeBadge}</td><td class="p-3 text-right font-mono ${valColor} font-bold text-xs">${val}</td><td class="p-3 text-center"><button onclick="app.softDeleteTransaction('${s.id}', event)" class="text-gray-600 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button></td>`;
                    listHistory.appendChild(tr);
                });
            },

            renderTrash() {
                const deleted = this.data.transactions.filter(t => t.deleted);
                const tbody = document.getElementById('trash-body'); tbody.innerHTML = '';
                document.getElementById('trashCount').innerText = deleted.length; document.getElementById('trashCount').style.display = deleted.length > 0 ? 'flex' : 'none';
                const bulkActions = document.getElementById('trash-bulk-actions');
                if(this.data.selectedTrashIds.length > 0) bulkActions.classList.remove('hidden'); else bulkActions.classList.add('hidden');
                if (deleted.length === 0) { document.getElementById('trash-empty').classList.remove('hidden'); return; }
                document.getElementById('trash-empty').classList.add('hidden');
                deleted.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-800 " + (this.data.selectedTrashIds.includes(t.id) ? "bg-white/10" : "");
                    tr.innerHTML = `<td class="p-3 text-center"><input type="checkbox" onclick="app.toggleTrashSelection('${t.id}')" class="accent-red-500 cursor-pointer" ${this.data.selectedTrashIds.includes(t.id)?'checked':''}></td><td class="p-3 text-xs font-mono text-gray-500">${t.date.split('T')[0]}</td><td class="p-3 font-bold text-xs text-white">${t.type.toUpperCase()}</td><td class="p-3 text-xs text-gray-400">${t.amount} ${t.coin||'USDT'}</td><td class="p-3 text-right"><button onclick="app.restoreTransaction('${t.id}')" class="text-neon-blue hover:text-white text-xs underline">Restore</button></td>`;
                    tbody.appendChild(tr);
                });
            },
            toggleTrashSelection(id) { if(this.data.selectedTrashIds.includes(id)) this.data.selectedTrashIds = this.data.selectedTrashIds.filter(i=>i!==id); else this.data.selectedTrashIds.push(id); this.renderTrash(); },
            toggleAllTrash() { const chk = document.getElementById('trash-check-all'); if(chk.checked) this.data.selectedTrashIds = this.data.transactions.filter(t => t.deleted).map(t => t.id); else this.data.selectedTrashIds = []; this.renderTrash(); },
            deletePermanentTrash() { if(!confirm("CẢNH BÁO: Hành động này không thể hoàn tác. Bạn có chắc chắn muốn xóa vĩnh viễn?")) return; this.data.transactions = this.data.transactions.filter(t => !this.data.selectedTrashIds.includes(t.id)); this.data.selectedTrashIds = []; this.saveData(); },
            restoreSelectedTrash() { this.data.transactions.forEach(t => { if(this.data.selectedTrashIds.includes(t.id)) t.deleted = false; }); this.data.selectedTrashIds = []; this.saveData(); },
            restoreTransaction(id) { const t = this.data.transactions.find(x => x.id === id); if(t) { t.deleted = false; this.saveData(); } },
            
            toggleDIHistorySelection(id, e) { if(e) e.stopPropagation(); if(this.data.selectedDIHistoryIds.includes(id)) this.data.selectedDIHistoryIds = this.data.selectedDIHistoryIds.filter(i=>i!==id); else this.data.selectedDIHistoryIds.push(id); this.renderDIView(); },
            toggleAllDIHistory() { const chk = document.getElementById('di-check-all'); let visibleDI = this.data.transactions.filter(t => (t.type === 'di_settle' || t.type === 'di_entry') && !t.deleted); visibleDI = visibleDI.filter(t => !(t.type === 'di_entry' && !t.settled)); if(chk.checked) this.data.selectedDIHistoryIds = visibleDI.map(t => t.id); else this.data.selectedDIHistoryIds = []; this.renderDIView(); },
            deleteSelectedDI() { if(!confirm("Chuyển các mục đã chọn vào thùng rác?")) return; this.data.transactions.forEach(t => { if(this.data.selectedDIHistoryIds.includes(t.id)) t.deleted = true; }); this.data.selectedDIHistoryIds = []; this.saveData(); },
            softDeleteTransaction(id, e) { if(e) e.stopPropagation(); if(confirm("Chuyển vào thùng rác?")) { const t = this.data.transactions.find(x => x.id === id); if(t){ t.deleted=true; this.saveData(); } } },
            toggleHistorySelection(id) { if(this.data.selectedHistoryIds.includes(id)) this.data.selectedHistoryIds=this.data.selectedHistoryIds.filter(i=>i!==id); else this.data.selectedHistoryIds.push(id); this.renderHistory(); },
            toggleAllHistory() {
                const chk = document.getElementById('history-check-all');
                let filtered = this.data.transactions.filter(t => !t.deleted && !t.type.includes('di'));
                if(chk.checked) { this.data.selectedHistoryIds = filtered.map(t => t.id).slice(0, 50); } else this.data.selectedHistoryIds = [];
                this.renderHistory();
            },
            deleteSelectedHistory() { if(!confirm("Xóa các mục đã chọn?")) return; this.data.transactions.forEach(t=>{if(this.data.selectedHistoryIds.includes(t.id)) t.deleted=true;}); this.data.selectedHistoryIds=[]; document.getElementById('history-check-all').checked=false; this.saveData(); },
            emptyTrash() { if(confirm("Xóa vĩnh viễn tất cả trong thùng rác?")) { this.data.transactions = this.data.transactions.filter(t => !t.deleted); this.saveData(); } },
            openCoinDetail(coin) { this.data.currentDetailCoin = coin; document.getElementById('detail-coin-name').innerText = coin; document.getElementById('detail-coin-icon').src = this.getCoinIcon(coin); document.getElementById('modal-coin-detail').classList.remove('hidden'); document.getElementById('modal-coin-detail').classList.add('flex'); this.setDetailFilter('all'); },
            renderCoinHistory() {
                const coin = this.data.currentDetailCoin;
                if(!coin) return;
                const tbody = document.getElementById('coin-detail-body');
                tbody.innerHTML = '';
                let related = this.data.transactions.filter(t => !t.deleted).filter(t => { if (t.coin === coin) return true; if (coin === 'USDT' && (t.type === 'deposit' || t.type === 'withdraw' || t.type === 'transfer')) return true; if (coin === 'USDT' && t.diType === 'buy_low') return true; if (t.type === 'di_settle') { const p = this.data.transactions.find(x => x.id === t.parentDiId); if(p && p.coin === coin) return true; if(coin === 'USDT' && (t.resultAsset === 'USDT' || t.settlementValueUSDT > 0)) return true; } return false; });
                const now = new Date(); const cutOff = new Date();
                if(this.data.detailFilterRange === 'week') cutOff.setDate(now.getDate() - 7);
                if(this.data.detailFilterRange === 'month') cutOff.setMonth(now.getMonth() - 1);
                if(this.data.detailFilterRange === 'year') cutOff.setFullYear(now.getFullYear() - 1);
                if(this.data.detailFilterRange !== 'all') related = related.filter(t => new Date(t.date) >= cutOff);
                related.sort((a,b) => { const dateA = new Date(a.date), dateB = new Date(b.date); return this.data.sortOrder === 'desc' ? dateB - dateA : dateA - dateB; });
                related.forEach(t => {
                    const tr = document.createElement('tr'); tr.className = "hover:bg-white/5 transition";
                    tr.onclick = (e) => { if(!e.target.closest('button')) app.openUniversalDetail(t.id); };
                    let typeHtml='', details='', change='';
                    if(t.type === 'buy') { typeHtml = `<span class="text-neon-green">MUA</span>`; details = `${this.formatNumber(t.price)} USDT`; change = `<span class="text-neon-green">+${this.formatNumber(t.amount - t.fee)}</span>`; } else if (t.type === 'sell') { typeHtml = `<span class="text-neon-red">BÁN</span>`; details = `${this.formatNumber(t.price)} USDT`; change = `<span class="text-neon-red">-${this.formatNumber(t.amount + t.fee)}</span>`; } else if (t.type === 'di_entry') { typeHtml = `<span class="text-neon-pink">DI LOCK</span>`; details = `${t.diType==='sell_high'?'Sell High':'Buy Low'} @ ${t.targetPrice}`; change = `<span class="text-gray-400">Lock ${this.formatNumber(t.amount)}</span>`; } else if (t.type === 'di_settle') { typeHtml = `<span class="text-neon-pink">DI SETTLE</span>`; details = `Result: ${t.resultAsset}`; change = `<span class="text-neon-green">+${this.formatNumber(t.resultAmount)}</span>`; } else if (t.type === 'transfer') { typeHtml = `<span class="text-orange-400">TRANSFER</span>`; details = `${t.network || 'Chain'}. Fee: ${t.fee}`; change = `<span class="text-red-400">-${this.formatNumber(t.amount)} ${t.coin}</span>`; } else { typeHtml = `<span class="text-neon-blue">${t.type.toUpperCase()}</span>`; details = `Rate: ${this.formatNumber(t.rate)}`; change = `<span class="${t.type==='deposit'?'text-neon-blue':'text-gray-400'}">${t.type==='deposit'?'+':'-'}${this.formatNumber(t.amount)}</span>`; }
                    tr.innerHTML = `<td class="p-3 text-xs text-gray-500 font-mono">${t.date.slice(5,10)}</td><td class="p-3 text-xs font-bold">${typeHtml}</td><td class="p-3 text-right text-xs text-gray-300">${details}</td><td class="p-3 text-right text-xs font-mono font-bold">${change}</td><td class="p-3 text-center"><button onclick="app.softDeleteTransaction('${t.id}', event)" class="text-gray-600 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button></td>`;
                    tbody.appendChild(tr);
                });
            },
            setDetailFilter(range) { this.data.detailFilterRange = range; const btns = document.querySelectorAll('.detail-filter-btn'); btns.forEach(b => { b.classList.remove('bg-neon-blue/20', 'text-neon-blue', 'active', 'border', 'border-neon-blue/50'); b.classList.add('text-gray-400'); if(b.textContent.toLowerCase().includes(range === 'all' ? 'tất cả' : (range === 'week' ? 'tuần' : (range === 'month' ? 'tháng' : 'năm')))) { b.classList.add('bg-neon-blue/20', 'text-neon-blue', 'active', 'border', 'border-neon-blue/50'); b.classList.remove('text-gray-400'); } }); this.renderCoinHistory(); },
            
            getAssetBalance(coin) {
                const { assets, usdtBalance } = this.calculatePortfolio();
                if(coin === 'USDT') return usdtBalance;
                return (assets[coin] ? assets[coin].amount : 0);
            },
            
            updateSpotBalanceDisplay() {
                const type = document.querySelector('input[name="spotType"]:checked').value;
                const coin = document.getElementById('spot-coin').value.toUpperCase();
                const display = document.getElementById('spot-balance-display');
                if(type === 'buy') {
                    const bal = this.getAssetBalance('USDT');
                    display.innerText = `Avail USDT: ${this.formatNumber(bal, true)}`;
                    display.className = "text-[9px] text-neon-green mt-1 font-mono text-right";
                } else {
                    const bal = this.getAssetBalance(coin);
                    display.innerText = `Avail ${coin}: ${this.formatNumber(bal)}`;
                    display.className = "text-[9px] text-neon-red mt-1 font-mono text-right";
                }
            },
            
            updateDIBalanceDisplay() {
                const type = document.querySelector('input[name="diType"]:checked').value;
                const coin = document.getElementById('di-asset').value.toUpperCase();
                const display = document.getElementById('di-balance-display');
                if(type === 'buy_low') {
                    const bal = this.getAssetBalance('USDT');
                    display.innerText = `Avail USDT: ${this.formatNumber(bal, true)}`;
                    display.className = "text-[9px] text-neon-green mt-1 font-mono text-right";
                } else {
                    const bal = this.getAssetBalance(coin);
                    display.innerText = `Avail ${coin}: ${this.formatNumber(bal)}`;
                    display.className = "text-[9px] text-neon-red mt-1 font-mono text-right";
                }
            },

            onSpotCoinInput(val) {
                this.updateSpotBalanceDisplay();
            },
            
            saveSpotTransaction() {
                const type = document.querySelector('input[name="spotType"]:checked').value;
                const total = parseFloat(document.getElementById('spot-total').value);
                const amount = parseFloat(document.getElementById('spot-amount').value);
                const coin = document.getElementById('spot-coin').value.toUpperCase();
                const { usdtBalance, assets } = this.calculatePortfolio();
                
                if (!this.data.editingId) {
                    if (type === 'buy' && total > usdtBalance) {
                        this.showToast(`Số dư không đủ! Có: ${this.formatNumber(usdtBalance)}`, 'error');
                        return;
                    }
                    if (type === 'sell') {
                        const currentCoinBal = assets[coin] ? assets[coin].amount : 0;
                        if (amount > currentCoinBal) {
                            this.showToast(`Số dư Coin không đủ! Có: ${this.formatNumber(currentCoinBal)}`, 'error');
                            return;
                        }
                    }
                }
                
                this.pushTx({ type: type, coin: coin, price: parseFloat(document.getElementById('spot-price').value), amount: amount, total: total, date: document.getElementById('spot-date').value, fee: 0, feeCoin: 'COIN' }, 'transaction', 'form-spot');
                this.showToast('Lưu giao dịch thành công!', 'success');
            },
            
            saveFiatTransaction() {
                const t = document.querySelector('input[name="fiatType"]:checked').value;
                const r = parseFloat(document.getElementById('fiat-rate').value);
                const amt = parseFloat(document.getElementById('fiat-amount').value);
                const unit = document.getElementById('fiat-unit').value;
                let finalUSDT = unit==='VND' ? amt/r : amt;
                if (t === 'withdraw' && !this.data.editingId) {
                    const { usdtBalance } = this.calculatePortfolio();
                    if (finalUSDT > usdtBalance) { this.showToast(`Số dư không đủ rút!`, 'error'); return; }
                }
                this.pushTx({ type: t, amount: finalUSDT, rate: r, fee:0, feeCoin:'USDT', date: new Date().toISOString() }, 'transaction', 'form-fiat');
                this.showToast('Lưu thành công!', 'success');
            },
            
            saveTransferTransaction() {
                const asset = document.getElementById('transfer-asset').value.toUpperCase();
                const amount = parseFloat(document.getElementById('transfer-amount').value);
                const fee = parseFloat(document.getElementById('transfer-fee').value) || 0;
                
                if (!asset || !amount) { this.showToast("Thiếu thông tin!", 'error'); return; }
                if (!this.data.editingId) {
                    const { assets, usdtBalance } = this.calculatePortfolio();
                    if(asset === 'USDT') {
                        if ((amount + fee) > usdtBalance) { this.showToast(`Số dư USDT không đủ!`, 'error'); return; }
                    } else {
                        const currentBal = assets[asset] ? assets[asset].amount : 0;
                        if ((amount + fee) > currentBal) { this.showToast(`Số dư ${asset} không đủ!`, 'error'); return; }
                    }
                }
                const network = document.getElementById('transfer-network').value;
                this.pushTx({ type: 'transfer', coin: asset, amount: amount, fee: fee, network: network, date: new Date().toISOString() }, 'transaction', 'form-transfer');
                this.showToast('Lưu thành công!', 'success');
            },
            
            saveDITransaction() {
                const coin = document.getElementById('di-asset').value.toUpperCase();
                const target = parseFloat(document.getElementById('di-target-price').value);
                const amount = parseFloat(document.getElementById('di-amount').value);
                const startStr = document.getElementById('di-start-date').value;
                const duration = parseFloat(document.getElementById('di-duration').value);
                const type = document.querySelector('input[name="diType"]:checked').value;

                if (!coin || isNaN(target) || isNaN(amount) || !startStr || isNaN(duration)) { this.showToast("Thiếu thông tin!", 'error'); return; }
                
                let { assets, usdtBalance } = this.calculatePortfolio();
                if (this.data.editingId) {
                    const oldTx = this.data.transactions.find(t => t.id === this.data.editingId);
                    if (oldTx) {
                        if (oldTx.diType === 'buy_low') usdtBalance += oldTx.amount;
                        else if (oldTx.diType === 'sell_high') { if (assets[oldTx.coin]) assets[oldTx.coin].amount += oldTx.amount; else assets[oldTx.coin] = { amount: oldTx.amount, locked: 0, totalCost: 0 }; }
                    }
                }

                if (type === 'buy_low') {
                    if (usdtBalance < 0 || amount > usdtBalance) { this.showToast(`Số dư USDT không đủ!`, 'error'); return; }
                } else {
                    const currentCoinBal = assets[coin] ? assets[coin].amount : 0;
                    if (currentCoinBal < 0 || amount > currentCoinBal) { this.showToast(`Số dư ${coin} không đủ!`, 'error'); return; }
                }

                const start = new Date(startStr); const end = new Date(start); end.setDate(end.getDate() + duration); const endStr = end.toISOString().split('T')[0];
                this.pushTx({ type: 'di_entry', diType: type, coin, amount, targetPrice: target, date: startStr, endDate: endStr, apr: parseFloat(document.getElementById('di-apr').value)||0, settled: false }, 'di', null);
                this.showToast('Đăng ký thành công!', 'success');
            },
            
            pushTx(d, m, f) {
                if(d.amount) {
                    if (this.data.editingId) {
                        const index = this.data.transactions.findIndex(t => t.id === this.data.editingId);
                        if (index !== -1) { this.data.transactions[index] = { ...this.data.transactions[index], ...d }; }
                        this.data.editingId = null;
                        if(document.getElementById('modal-title')) document.getElementById('modal-title').innerText = "THÊM GIAO DỊCH";
                        if(document.getElementById('btn-save-spot')) document.getElementById('btn-save-spot').innerText = "Xác Nhận";
                        if(document.getElementById('btn-save-fiat')) document.getElementById('btn-save-fiat').innerText = "Xác nhận";
                        if(document.getElementById('btn-save-transfer')) document.getElementById('btn-save-transfer').innerText = "Chuyển đi";
                        if(document.getElementById('di-modal-title')) document.getElementById('di-modal-title').innerHTML = '<i class="fa-solid fa-chart-line text-neon-pink"></i> Tạo Dual Investment';
                        if(document.getElementById('btn-save-di')) document.getElementById('btn-save-di').innerText = "Xác nhận";
                    } else {
                        this.data.transactions.push({ id: crypto.randomUUID(), ...d, deleted: false });
                    }
                    this.saveData(); 
                    this.closeModal(m);
                    if(f) document.getElementById(f).reset();
                }
            },
            renderChart(labels, data, colors, totalValue) { const ctx = document.getElementById('portfolioChart').getContext('2d'); if (this.chartInstance) this.chartInstance.destroy(); this.chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0, hoverOffset: 10, borderColor: '#000' }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false } } } }); const leg = document.getElementById('chart-legend'); leg.innerHTML = ''; labels.forEach((l, i) => { const val = data[i], pct = totalValue > 0 ? (val/totalValue*100).toFixed(1) : 0; leg.innerHTML += `<div class="flex items-center justify-between text-xs p-2 rounded hover:bg-white/5 transition"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full shadow-[0_0_5px_${colors[i]}]" style="background-color:${colors[i]}"></span><span class="text-gray-300 font-bold">${l}</span></div><div class="text-right"><span class="text-gray-500 mr-2">$${Math.round(val).toLocaleString()}</span><span class="font-mono font-bold text-white">${pct}%</span></div></div>`; }); },
            renderDICalculator() {
                const type = document.querySelector('input[name="diType"]:checked').value;
                const asset = document.getElementById('di-asset').value.toUpperCase();
                const target = parseFloat(document.getElementById('di-target-price').value)||0;
                const amount = parseFloat(document.getElementById('di-amount').value)||0;
                const apr = parseFloat(document.getElementById('di-apr').value)||0;
                const startStr = document.getElementById('di-start-date').value;
                const duration = parseFloat(document.getElementById('di-duration').value)||0;
                
                this.updateDIBalanceDisplay(); 

                if(type==='sell_high') { document.getElementById('di-type-high').classList.remove('opacity-50'); document.getElementById('di-type-low').classList.add('opacity-50'); document.getElementById('di-type-high').querySelector('.check-icon').classList.remove('hidden'); document.getElementById('di-type-low').querySelector('.check-icon').classList.add('hidden'); } else { document.getElementById('di-type-high').classList.add('opacity-50'); document.getElementById('di-type-low').classList.remove('opacity-50'); document.getElementById('di-type-high').querySelector('.check-icon').classList.add('hidden'); document.getElementById('di-type-low').querySelector('.check-icon').classList.remove('hidden'); } document.getElementById('label-below').innerText = `Giá < ${target ? target : 'Target'}`; document.getElementById('label-above').innerText = `Giá ≥ ${target ? target : 'Target'}`; let calcData = { below: null, above: null }; if(!isNaN(target) && !isNaN(amount) && !isNaN(apr) && startStr && duration > 0) { const days = duration; const interest = amount * (apr/100) * (days/365); const totalRaw = amount + interest; document.getElementById('summ-amount-detail').innerText = `${this.formatNumber(amount)} ${type==='sell_high' ? asset : 'USDT'}`; document.getElementById('summ-interest-detail').innerText = `+${this.formatNumber(interest)} (${days}d)`; document.getElementById('summ-total-detail').innerText = `${this.formatNumber(totalRaw)} ${type==='sell_high' ? asset : 'USDT'}`; if(type === 'sell_high') { calcData.below = `${this.formatNumber(totalRaw)} ${asset}`; calcData.above = `${this.formatNumber(totalRaw * target)} USDT`; } else { calcData.below = `${this.formatNumber(totalRaw / target)} ${asset}`; calcData.above = `${this.formatNumber(totalRaw)} USDT`; } document.getElementById('val-below-main').innerText = calcData.below; document.getElementById('val-above-main').innerText = calcData.above; this.data.diPreviewData = calcData; this.updateFinalOutcome(); this.renderDIScenarioChart(asset, target, type); } },
            renderDIScenarioChart(asset, targetPrice, type) { const ctx = document.getElementById('diScenarioChart').getContext('2d'); const placeholder = document.getElementById('di-chart-placeholder'); if(!targetPrice || !asset) { if(this.data.diChartInstance) this.data.diChartInstance.destroy(); placeholder.classList.remove('hidden'); return; } placeholder.classList.add('hidden'); const currentPrice = this.getRate(asset); if(currentPrice === 0) return; const labels = ['Current', 'Day 1', 'Day 2', 'Expiry']; const colorCurrent = '#ffffff'; const colorTarget = '#ff00ff'; const dataPoints = [currentPrice, currentPrice + (targetPrice - currentPrice)*0.3, currentPrice + (targetPrice - currentPrice)*0.6, targetPrice]; const diffPct = Math.abs(targetPrice - currentPrice) / currentPrice; let yMin, yMax; if (diffPct < 0.05) { const minVal = Math.min(currentPrice, targetPrice); const maxVal = Math.max(currentPrice, targetPrice); yMin = minVal * 0.99; yMax = maxVal * 1.01; } if(this.data.diChartInstance) this.data.diChartInstance.destroy(); this.data.diChartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Projection', data: dataPoints, borderColor: '#888', borderDash: [5, 5], pointBackgroundColor: colorCurrent, borderWidth: 2, tension: 0.4, fill: false }] }, options: { responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' }, plugins: { legend: { display: false }, annotation: { annotations: { targetLine: { type: 'line', yMin: targetPrice, yMax: targetPrice, borderColor: colorTarget, borderWidth: 2, label: { display: true, content: `Target: ${targetPrice}`, position: 'end', backgroundColor: colorTarget, color: 'black' } }, currentLine: { type: 'line', yMin: currentPrice, yMax: currentPrice, borderColor: '#00F0FF', borderWidth: 1, borderDash: [2,2], label: { display: true, content: `Current: ${currentPrice}`, position: 'start', backgroundColor: '#00F0FF', color: 'black', font: { size: 10 } } } } } }, scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666', font: { family: 'JetBrains Mono' } }, min: yMin, max: yMax }, x: { display: false } } } }); },
            setDIScenario(scen) { this.data.diPreviewScenario = scen; document.querySelectorAll('.neon-option').forEach(el => el.classList.remove('active')); document.getElementById(`scen-${scen}`).classList.add('active'); this.updateFinalOutcome(); },
            updateFinalOutcome() { const data = this.data.diPreviewData; if(!data) return; const scen = this.data.diPreviewScenario; const val = scen === 'below' ? data.below : data.above; document.getElementById('summ-receive').innerText = val; },
            settleDI(id, reached, event) { if(event) event.stopPropagation(); const di = this.data.transactions.find(t => t.id === id); if(!confirm("Xác nhận tất toán gói này?")) return; const start = new Date(di.date), end = new Date(di.endDate); const days = Math.max(1, Math.ceil((end-start)/(1000*60*60*24))); const interest = di.amount * (di.apr/100) * (days/365); let rAmt = 0, rAsset = '', sVal = 0; if (di.diType === 'sell_high') { if (reached) { rAsset = 'USDT'; rAmt = (di.amount + interest) * di.targetPrice; sVal = rAmt; } else { rAsset = di.coin; rAmt = di.amount + interest; sVal = rAmt * (this.getRate(di.coin)||di.targetPrice); } } else { if (reached) { rAsset = di.coin; rAmt = (di.amount + interest) / di.targetPrice; sVal = di.amount + interest; } else { rAsset = 'USDT'; rAmt = di.amount + interest; sVal = rAmt; } } this.data.transactions.push({ id: crypto.randomUUID(), type: 'di_settle', parentDiId: id, date: new Date().toISOString(), resultAsset: rAsset, resultAmount: rAmt, apr: di.apr, settlementValueUSDT: sVal, deleted: false }); di.settled = true; this.saveData(); this.showToast('Tất toán thành công!', 'success'); },
            openAddTransactionModal() { 
                this.data.editingId = null; 
                if(document.getElementById('modal-title')) document.getElementById('modal-title').innerText = "THÊM GIAO DỊCH"; 
                if(document.getElementById('btn-save-spot')) document.getElementById('btn-save-spot').innerText = "Xác Nhận"; 
                if(document.getElementById('btn-save-fiat')) document.getElementById('btn-save-fiat').innerText = "Xác nhận";
                if(document.getElementById('btn-save-transfer')) document.getElementById('btn-save-transfer').innerText = "Chuyển đi";
                if(document.getElementById('di-modal-title')) document.getElementById('di-modal-title').innerHTML = '<i class="fa-solid fa-chart-line text-neon-pink"></i> Tạo Dual Investment';
                if(document.getElementById('btn-save-di')) document.getElementById('btn-save-di').innerText = "Xác nhận";
                if(document.getElementById('form-spot')) document.getElementById('form-spot').reset(); 
                if(document.getElementById('form-fiat')) document.getElementById('form-fiat').reset(); 
                if(document.getElementById('form-transfer')) document.getElementById('form-transfer').reset(); 
                document.getElementById('di-asset').value = ''; 
                document.getElementById('di-target-price').value = ''; 
                document.getElementById('di-amount').value = ''; 
                document.getElementById('di-apr').value = ''; 
                document.getElementById('di-duration').value = ''; 
                const vnTime = new Date().toLocaleString("sv-SE", { timeZone: "Asia/Ho_Chi_Minh" }).replace(' ', 'T').slice(0, 16); 
                const todayStr = new Date().toLocaleString("sv-SE", { timeZone: "Asia/Ho_Chi_Minh" }).slice(0, 10);
                document.getElementById('spot-date').value = vnTime; 
                document.getElementById('di-start-date').value = todayStr;
                document.getElementById('modal-transaction').classList.remove('hidden'); 
                document.getElementById('modal-transaction').classList.add('flex'); 
                this.updateSpotBalanceDisplay(); 
            },
            showTransactionModal() { document.getElementById('modal-transaction').classList.remove('hidden'); document.getElementById('modal-transaction').classList.add('flex'); this.updateSpotBalanceDisplay(); },
            openDIModal() { this.data.editingId = null; if(document.getElementById('di-modal-title')) document.getElementById('di-modal-title').innerHTML = '<i class="fa-solid fa-chart-line text-neon-pink"></i> Tạo Dual Investment'; if(document.getElementById('btn-save-di')) document.getElementById('btn-save-di').innerText = "Xác nhận"; document.getElementById('di-asset').value = ''; document.getElementById('di-target-price').value = ''; document.getElementById('di-amount').value = ''; document.getElementById('di-apr').value = ''; document.getElementById('di-duration').value = ''; const todayStr = new Date().toLocaleString("sv-SE", { timeZone: "Asia/Ho_Chi_Minh" }).slice(0, 10); document.getElementById('di-start-date').value = todayStr; document.getElementById('modal-di').classList.remove('hidden'); document.getElementById('modal-di').classList.add('flex'); this.updateDIBalanceDisplay(); },
            toggleTrashModal() { const el = document.getElementById('modal-trash'); if (el.classList.contains('hidden')) { el.classList.remove('hidden'); el.classList.add('flex'); this.renderTrash(); } else { el.classList.add('hidden'); el.classList.remove('flex'); } },
            closeModal(name) { document.getElementById(`modal-${name}`).classList.add('hidden'); document.getElementById(`modal-${name}`).classList.remove('flex'); },
            switchModalTab(tab) { if (tab === 'spot') { document.getElementById('form-spot').classList.remove('hidden'); document.getElementById('form-fiat').classList.add('hidden'); document.getElementById('form-transfer').classList.add('hidden'); document.getElementById('modal-tab-spot').classList.replace('text-gray-500','text-neon-gold'); document.getElementById('modal-tab-spot').classList.add('border-b-2'); document.getElementById('modal-tab-fiat').classList.replace('text-blue-500','text-gray-500'); document.getElementById('modal-tab-fiat').classList.remove('border-b-2'); document.getElementById('modal-tab-transfer').classList.replace('text-orange-500','text-gray-500'); document.getElementById('modal-tab-transfer').classList.remove('border-b-2'); } else if (tab === 'fiat') { document.getElementById('form-spot').classList.add('hidden'); document.getElementById('form-fiat').classList.remove('hidden'); document.getElementById('form-transfer').classList.add('hidden'); document.getElementById('modal-tab-spot').classList.replace('text-neon-gold','text-gray-500'); document.getElementById('modal-tab-spot').classList.remove('border-b-2'); document.getElementById('modal-tab-fiat').classList.replace('text-gray-500','text-blue-500'); document.getElementById('modal-tab-fiat').classList.add('border-b-2'); document.getElementById('modal-tab-transfer').classList.replace('text-orange-500','text-gray-500'); document.getElementById('modal-tab-transfer').classList.remove('border-b-2'); } else { document.getElementById('form-spot').classList.add('hidden'); document.getElementById('form-fiat').classList.add('hidden'); document.getElementById('form-transfer').classList.remove('hidden'); document.getElementById('modal-tab-spot').classList.replace('text-neon-gold','text-gray-500'); document.getElementById('modal-tab-spot').classList.remove('border-b-2'); document.getElementById('modal-tab-fiat').classList.replace('text-blue-500','text-gray-500'); document.getElementById('modal-tab-fiat').classList.remove('border-b-2'); document.getElementById('modal-tab-transfer').classList.replace('text-gray-500','text-orange-500'); document.getElementById('modal-tab-transfer').classList.add('border-b-2'); } },
            switchTab(t) { ['portfolio', 'history', 'di'].forEach(x => { document.getElementById(`view-${x}`).classList.add('hidden'); document.getElementById(`tab-${x}`).className = 'tab-inactive py-3 px-3 md:px-4 font-bold text-xs md:text-sm tracking-wide transition uppercase whitespace-nowrap'; }); document.getElementById(`view-${t}`).classList.remove('hidden'); document.getElementById(`tab-${t}`).className = 'tab-active py-3 px-3 md:px-4 font-bold text-xs md:text-sm tracking-wide transition uppercase whitespace-nowrap'; if (t === 'di') this.renderDIView(); if (t === 'history') this.renderHistory(); },
            fetchSpotPriceInModal() { const c = document.getElementById('spot-coin').value.toUpperCase(); const p = this.getRate(c); if(p>0) { document.getElementById('spot-price').value=p; this.calculateSpotLogic('price'); } },
            calculateSpotLogic(src) { const p = parseFloat(document.getElementById('spot-price').value)||0, a = parseFloat(document.getElementById('spot-amount').value)||0, t = parseFloat(document.getElementById('spot-total').value)||0; if(src==='price' && a>0) document.getElementById('spot-total').value = p*a; else if(src==='amount' && p>0) document.getElementById('spot-total').value = p*a; else if(src==='total' && p>0) document.getElementById('spot-amount').value = t/p; },
            calculateFiatEstimate() { const type = document.querySelector('input[name="fiatType"]:checked').value, rate = parseFloat(document.getElementById('fiat-rate').value)||0, amt = parseFloat(document.getElementById('fiat-amount').value)||0, unit = document.getElementById('fiat-unit').value; if(rate===0) return; let val = unit==='VND' ? amt/rate : (type==='deposit' ? amt : amt*rate); document.getElementById('fiat-estimate').innerText = type==='deposit' ? `${this.formatNumber(unit === 'VND' ? amt/rate : amt)} USDT` : `${(unit === 'VND' ? amt : amt*rate).toLocaleString()} VND`; },
            toggleSpotType(t) {
                const b = document.getElementById('lbl-buy'), s = document.getElementById('lbl-sell');
                if(t==='buy') { b.className="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold transition bg-emerald-600 text-white"; s.className="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold text-gray-500 transition"; }
                else { b.className="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold text-gray-500 transition"; s.className="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold transition bg-red-600 text-white"; }
                this.updateSpotBalanceDisplay();
            },
            toggleFiatType(t) { const d = document.getElementById('lbl-deposit'), w = document.getElementById('lbl-withdraw'); if(t==='deposit') { d.className="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold transition bg-blue-600 text-white"; w.className="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold text-gray-500 transition"; } else { d.className="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold text-gray-500 transition"; w.className="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold transition bg-gray-600 text-white"; } this.calculateFiatEstimate(); }
        };
        document.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>