<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Pro - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: { dark: '#050505', card: 'rgba(20, 20, 25, 0.85)', input: 'rgba(255, 255, 255, 0.05)' },
                        neon: { gold: '#FFD700', blue: '#00F0FF', pink: '#FF00FF', green: '#00FF9D', red: '#FF4D4D' }
                    },
                    fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { pulseSlow: 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        body { background: radial-gradient(circle at 50% -20%, #1a1c29 0%, #050505 100%); color: #EAECEF; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .glass-panel { background: rgba(20, 20, 25, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .input-modern { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .input-modern:focus { border-color: #00F0FF; box-shadow: 0 0 10px rgba(0, 240, 255, 0.2); }
        @media (max-width: 768px) { .hide-on-mobile { display: none; } .glass-panel { padding: 1rem; } th, td { padding: 0.75rem 0.5rem; } }
        .btn-neon { position: relative; overflow: hidden; transition: all 0.3s ease; text-shadow: 0 0 5px rgba(255,255,255,0.3); border: 1px solid transparent; }
        .btn-neon-blue { background: linear-gradient(135deg, rgba(0, 240, 255, 0.1), rgba(0, 240, 255, 0.05)); border-color: rgba(0, 240, 255, 0.4); color: #00F0FF; }
        .btn-neon-pink { background: linear-gradient(135deg, rgba(255, 0, 255, 0.1), rgba(255, 0, 255, 0.05)); border-color: rgba(255, 0, 255, 0.4); color: #FF00FF; }
        .btn-neon-red { background: linear-gradient(135deg, rgba(255, 77, 77, 0.1), rgba(255, 77, 77, 0.05)); border-color: rgba(255, 77, 77, 0.4); color: #FF4D4D; }
        .btn-solid-gold { background: linear-gradient(90deg, #F0B90B, #d49e06); color: black; font-weight: bold; box-shadow: 0 0 10px rgba(240, 185, 11, 0.3); }
        .tab-active { border-bottom: 2px solid #00F0FF; color: #00F0FF; text-shadow: 0 0 8px rgba(0, 240, 255, 0.5); }
        .tab-inactive { color: #848E9C; }
        .neon-option.active { border-color: #00F0FF; background: rgba(0, 240, 255, 0.05); box-shadow: 0 0 15px rgba(0, 240, 255, 0.3); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .toast-container { position: fixed; bottom: 20px; right: 20px; left: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; align-items: flex-end; }
        .toast { pointer-events: auto; background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(10px); border: 1px solid #333; color: #fff; padding: 12px 20px; border-radius: 8px; display: flex; items-center; gap: 12px; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }
        .ticker-wrap { width: 100%; overflow: hidden; white-space: nowrap; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }
        .ticker-content { display: inline-block; animation: marquee 40s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans selection:bg-neon-blue selection:text-black pb-20 md:pb-0">

    <div id="toast-container" class="toast-container"></div>

    <div class="bg-black/60 border-b border-white/5 py-2 px-4 flex items-center overflow-hidden h-12">
        <div class="flex items-center gap-2 text-[10px] md:text-xs font-mono text-neon-blue shrink-0 mr-4 z-10 bg-opacity-80 bg-black/20 backdrop-blur-sm pr-4 border-r border-white/10">
            <i class="fa-solid fa-chart-line"></i> LIVE
        </div>
        <div id="ticker-wrapper" class="flex-1 overflow-hidden relative cursor-grab active:cursor-grabbing h-full flex items-center">
            <div id="ticker-content" class="flex items-center gap-0 absolute left-0 whitespace-nowrap will-change-transform">
                <span class="text-gray-500 text-xs px-4">Đang tải dữ liệu thị trường...</span>
            </div>
        </div>
    </div>

    <header class="glass-panel sticky top-0 z-40">
        <div class="container mx-auto px-4 h-16 md:h-20 flex items-center justify-between">
            <div class="flex items-center gap-3 md:gap-4 cursor-pointer hover:opacity-80 transition" onclick="location.reload()">
                <div class="relative w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-tr from-yellow-400 to-yellow-600 flex items-center justify-center text-black font-bold text-lg md:text-2xl shadow-[0_0_15px_rgba(250,204,21,0.5)]">
                    <i class="fa-brands fa-bitcoin"></i>
                    <div class="absolute -bottom-1 -right-1 w-2 md:w-3 h-2 md:h-3 bg-neon-green rounded-full animate-pulse"></div>
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold tracking-tight text-white leading-tight drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">NEON CLOUD</h1>
                    <div class="text-[8px] md:text-[10px] text-neon-blue tracking-[0.2em] uppercase font-bold" id="sync-status">Offline Local</div>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-3">
                <div id="auth-container" class="border-r border-gray-700 pr-3 mr-1">
                    <button onclick="app.login()" id="btn-login" class="text-xs bg-white text-black px-3 py-1.5 rounded font-bold hover:bg-gray-200 transition flex items-center gap-2">
                        <i class="fa-brands fa-google"></i> Login
                    </button>
                    <div id="user-info" class="hidden flex items-center gap-2">
                        <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-neon-blue">
                        <div class="flex flex-col items-start leading-none justify-center">
                            <span id="user-email" class="text-[10px] text-neon-blue font-mono font-bold mb-1 max-w-[100px] truncate">...</span>
                            <button onclick="app.logout()" class="text-[10px] text-red-400 hover:text-white underline font-bold">Đăng xuất</button>
                        </div>
                    </div>
                </div>
                <button onclick="app.manualRefresh()" class="btn-neon btn-neon-blue text-xs font-bold p-2 md:py-2 md:px-4 rounded-lg flex items-center gap-2">
                    <i class="fa-solid fa-sync" id="refresh-icon"></i> <span class="hidden md:inline">Refresh</span>
                </button>
                <button onclick="app.toggleTrashModal()" class="relative p-2 md:p-3 text-gray-500 hover:text-red-400 transition">
                    <i class="fa-solid fa-trash-can text-lg"></i>
                    <span id="trashCount" class="absolute top-1 right-1 bg-red-600 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full hidden shadow-[0_0_5px_#ef4444]">0</span>
                </button>
                <button onclick="app.openAddTransactionModal()" class="btn-solid-gold hover:bg-yellow-400 text-black text-sm font-bold p-2 md:py-2.5 md:px-6 rounded-lg transition transform active:scale-95 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> <span class="hidden md:inline">Giao dịch</span>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 container mx-auto px-2 md:px-4 py-4 md:py-8">
        <div class="flex border-b border-gray-800 mb-6 md:mb-8 overflow-x-auto gap-2 md:gap-4 no-scrollbar">
            <button onclick="app.switchTab('portfolio')" id="tab-portfolio" class="tab-active py-3 px-3 md:px-4 font-bold text-xs md:text-sm tracking-wide transition uppercase whitespace-nowrap"><i class="fa-solid fa-chart-pie mr-1 md:mr-2"></i>Tổng quan</button>
            <button onclick="app.switchTab('history')" id="tab-history" class="tab-inactive py-3 px-3 md:px-4 font-bold text-xs md:text-sm tracking-wide transition uppercase whitespace-nowrap"><i class="fa-solid fa-list-ul mr-1 md:mr-2"></i>Lịch sử</button>
            <button onclick="app.switchTab('di')" id="tab-di" class="tab-inactive py-3 px-3 md:px-4 font-bold text-xs md:text-sm tracking-wide transition uppercase whitespace-nowrap"><i class="fa-solid fa-robot mr-1 md:mr-2"></i>Dual Investment</button>
        </div>

        <div id="view-portfolio" class="animate-fade-in space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6">
                <div class="glass-panel p-4 md:p-6 rounded-2xl border-t-2 border-neon-gold col-span-2 md:col-span-1">
                    <div class="text-gray-400 text-[10px] md:text-xs uppercase font-bold tracking-widest mb-2">Tổng tài sản (Equity)</div>
                    <div class="flex items-center gap-2"><div class="text-2xl md:text-3xl font-bold text-white font-mono drop-shadow-[0_0_10px_rgba(255,215,0,0.3)]" id="total-balance">$0.00</div><button onclick="app.togglePrivacy()" class="text-gray-500 hover:text-white transition p-1"><i class="fa-solid fa-eye" id="privacy-icon"></i></button></div>
                    <div class="text-[10px] md:text-xs text-neon-green mt-2 flex items-center gap-1"><i class="fa-solid fa-wallet"></i> Avail: <span id="usdt-available" class="font-bold text-white ml-1">0.00</span> USDT</div>
                </div>
                <div class="glass-panel p-4 md:p-6 rounded-2xl border-t-2 border-gray-500">
                    <div class="text-gray-400 text-[10px] md:text-xs uppercase font-bold tracking-widest mb-2">Vốn thực (Net Cost)</div>
                    <div class="text-xl md:text-3xl font-bold text-white font-mono" id="total-invested">$0.00</div>
                </div>
                <div class="glass-panel p-4 md:p-6 rounded-2xl border-t-2 border-neon-blue">
                    <div class="text-gray-400 text-[10px] md:text-xs uppercase font-bold tracking-widest mb-2">Unrealized PnL</div>
                    <div class="text-xl md:text-3xl font-bold font-mono" id="unrealized-pnl">$0.00</div>
                    <div class="text-xs md:text-sm font-bold mt-1" id="unrealized-pnl-pct">0.00%</div>
                </div>
                <div class="glass-panel p-4 md:p-6 rounded-2xl border-t-2 border-neon-pink">
                    <div class="text-gray-400 text-[10px] md:text-xs uppercase font-bold tracking-widest mb-2">Realized PnL</div>
                    <div class="text-xl md:text-3xl font-bold font-mono" id="realized-pnl">$0.00</div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                <div class="glass-panel p-4 md:p-6 rounded-2xl lg:col-span-1 h-fit">
                    <h3 class="text-xs md:text-sm font-bold mb-4 text-neon-blue uppercase tracking-widest border-b border-gray-800 pb-2">Phân bổ</h3>
                    <div class="flex flex-col items-center"><div class="relative w-48 h-48 md:w-56 md:h-56 mb-4"><canvas id="portfolioChart"></canvas></div><div id="chart-legend" class="w-full mt-2 max-h-48 overflow-y-auto pr-1 custom-scrollbar space-y-2"></div></div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-panel p-4 md:p-6 rounded-2xl">
                         <h3 class="text-xs md:text-sm font-bold mb-4 text-neon-green uppercase tracking-widest border-b border-gray-800 pb-2">Hiệu suất Tài sản</h3>
                         <div class="relative w-full h-48 md:h-64"><canvas id="performanceChart"></canvas></div>
                    </div>
                    <div class="glass-panel p-4 md:p-6 rounded-2xl overflow-x-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xs md:text-sm font-bold text-white uppercase tracking-widest">Holdings</h3>
                            <label class="flex items-center cursor-pointer gap-2"><input type="checkbox" id="hide-small-assets" class="accent-neon-green" onchange="app.toggleSmallAssets()"><span class="text-[10px] md:text-xs text-gray-400">Ẩn rác</span></label>
                        </div>
                        <table class="w-full text-left border-collapse min-w-[500px]">
                            <thead><tr class="text-[10px] md:text-xs text-gray-500 border-b border-gray-800 uppercase font-mono"><th class="py-3 px-2">Coin</th><th class="py-3 px-2 text-right">Holdings</th><th class="py-3 px-2 text-right hide-on-mobile">Avg Price</th><th class="py-3 px-2 text-right">Price</th><th class="py-3 px-2 text-right">Value</th><th class="py-3 px-2 text-right">PnL</th></tr></thead>
                            <tbody id="assets-table-body" class="text-sm font-medium text-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

       <div id="view-history" class="hidden animate-fade-in">
            <div class="glass-panel p-4 rounded-2xl">
                 <div class="flex flex-col md:flex-row gap-3 mb-4 border-b border-gray-800 pb-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 flex-1">
                        <select id="hist-filter-type" onchange="app.renderHistory()" class="input-modern rounded-lg px-2 py-1 text-xs text-white">
                            <option value="all">Tất cả loại</option>
                            <option value="buy_sell">Mua / Bán</option>
                            <option value="fiat">Nạp / Rút</option>
                        </select>
                        <select id="hist-sort" onchange="app.renderHistory()" class="input-modern rounded-lg px-2 py-1 text-xs text-white">
                            <option value="desc">Mới nhất</option>
                            <option value="asc">Cũ nhất</option>
                        </select>
                        <input type="date" id="hist-date-start" onchange="app.renderHistory()" class="input-modern rounded-lg px-2 py-1 text-xs text-white placeholder-gray-500">
                        <input type="date" id="hist-date-end" onchange="app.renderHistory()" class="input-modern rounded-lg px-2 py-1 text-xs text-white">
                    </div>
                    <div class="flex gap-2">
                         <button onclick="app.resetHistoryFilter()" class="px-3 py-1 rounded-lg bg-gray-800 text-xs text-gray-400 hover:text-white"><i class="fa-solid fa-rotate-right"></i></button>
                         <button onclick="app.exportToExcel()" class="btn-neon btn-neon-green px-4 py-1 rounded-lg text-xs font-bold flex items-center gap-2"><i class="fa-solid fa-file-excel"></i> Xuất Excel</button>
                    </div>
                 </div>

                 <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[700px]">
                        <thead class="bg-black/40 text-xs text-gray-400 font-mono">
                            <tr><th class="p-3">Time</th><th class="p-3">Type</th><th class="p-3">Detail</th><th class="p-3 text-right">Price</th><th class="p-3 text-right">Amount</th><th class="p-3 text-right">Total/Fee</th><th class="p-3 text-center">Act</th></tr>
                        </thead>
                        <tbody id="history-table-body" class="text-sm divide-y divide-gray-800 text-gray-300"></tbody>
                    </table>
                 </div>
            </div>
        </div>

        <div id="view-di" class="hidden animate-fade-in">
             <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-white"><i class="fa-solid fa-robot text-neon-pink"></i> Dual Investment</h2><button onclick="app.openDIModal()" class="btn-neon btn-neon-pink text-xs font-bold py-2 px-4 rounded-lg"><i class="fa-solid fa-plus"></i> Tạo gói</button></div>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <div><h3 class="text-xs font-bold text-neon-green mb-4 uppercase tracking-widest">Đang hoạt động</h3><div class="grid grid-cols-1" id="di-list-active"></div></div>
                 
                 <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Lịch sử</h3>
                        <div class="flex gap-2">
                             <select id="di-hist-sort" onchange="app.renderDIView()" class="bg-gray-800 text-[10px] text-white rounded px-2 py-1 border border-gray-700">
                                <option value="desc">Mới nhất</option>
                                <option value="asc">Cũ nhất</option>
                            </select>
                        </div>
                    </div>
                    <div class="glass-panel rounded-2xl overflow-hidden border border-gray-800 h-[500px] overflow-y-auto">
                        <table class="w-full text-left text-sm"><tbody id="di-list-history" class="divide-y divide-gray-800"></tbody></table>
                    </div>
                 </div>
             </div>
        </div>
    </main>

  <div id="modal-transaction" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[70] backdrop-blur-md">
        <div class="glass-panel w-full md:max-w-xl rounded-2xl border border-gray-700 overflow-hidden max-h-[90vh] overflow-y-auto m-4">
            <div class="bg-black/60 px-6 py-4 flex justify-between items-center border-b border-gray-800"><h3 class="text-lg font-bold text-white">GIAO DỊCH</h3><button onclick="app.closeModal('transaction')" class="text-gray-500 hover:text-white text-2xl">&times;</button></div>
            <div class="flex border-b border-gray-800"><button onclick="app.switchModalTab('spot')" id="modal-tab-spot" class="flex-1 py-4 text-sm font-bold text-neon-gold border-b-2 border-neon-gold uppercase">Spot</button><button onclick="app.switchModalTab('fiat')" id="modal-tab-fiat" class="flex-1 py-4 text-sm font-bold text-gray-500 uppercase">Fiat</button></div>
            <div class="p-6">
                <form id="form-spot" class="space-y-4">
                    <div class="flex gap-3"><div class="w-1/2"><label class="text-[10px] text-gray-400 block mb-1">Loại</label><div class="flex bg-black/40 rounded-lg p-1 border border-gray-700"><label class="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold bg-emerald-600 text-white" id="lbl-buy"><input type="radio" name="spotType" value="buy" checked class="hidden" onchange="app.toggleSpotType('buy')"> MUA</label><label class="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold text-gray-500" id="lbl-sell"><input type="radio" name="spotType" value="sell" class="hidden" onchange="app.toggleSpotType('sell')"> BÁN</label></div></div><div class="w-1/2"><label class="text-[10px] text-gray-400 block mb-1">Thời gian</label><input type="datetime-local" id="spot-date" class="input-modern w-full rounded-lg px-2 py-2 text-white text-xs"></div></div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-neon-blue block mb-1 flex justify-between"><span>Coin</span> <span id="spot-live-price" class="text-neon-gold font-mono"></span></label>
                            <input type="text" id="spot-coin" oninput="app.onSpotCoinInput(this.value)" class="input-modern w-full rounded-lg px-3 py-2 text-white uppercase font-bold" placeholder="BTC">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Giá đặt lệnh</label>
                            <input type="number" id="spot-price" step="any" oninput="app.calculateSpotLogic('price')" class="input-modern w-full rounded-lg px-3 py-2 text-neon-gold font-mono">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1 flex justify-between"><span>Số lượng</span> <span id="spot-balance-display" class="text-xs text-neon-green cursor-pointer hover:underline" onclick="app.fillMaxSpot()">Avail: 0</span></label>
                            <input type="number" id="spot-amount" step="any" oninput="app.calculateSpotLogic('amount')" class="input-modern w-full rounded-lg px-3 py-2 text-white font-mono font-bold">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Tổng USDT</label>
                            <input type="number" id="spot-total" step="any" oninput="app.calculateSpotLogic('total')" class="input-modern w-full rounded-lg px-3 py-2 text-white font-mono font-bold">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1">Phí giao dịch (Mặc định)</label>
                        <div class="flex">
                            <input type="number" id="spot-fee" step="any" value="0" class="input-modern w-full rounded-l-lg px-3 py-2 text-red-400 font-mono">
                            <div class="bg-gray-800 text-gray-400 text-xs border border-gray-700 px-3 py-2 rounded-r-lg flex items-center" id="spot-fee-unit">Coin/USDT</div>
                        </div>
                    </div>

                    <button type="button" onclick="app.saveSpotTransaction()" class="btn-solid-gold w-full py-3 rounded-lg mt-4 text-sm font-bold uppercase" id="btn-save-spot">Xác Nhận</button>
                </form>

                <form id="form-fiat" class="space-y-4 hidden">
                    <div class="flex gap-4"><div class="w-1/2"><label class="text-[10px] text-gray-400 block mb-1">Loại</label><div class="flex bg-black/40 rounded-lg p-1 border border-gray-700"><label class="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold bg-blue-600 text-white" id="lbl-deposit"><input type="radio" name="fiatType" value="deposit" checked class="hidden" onchange="app.toggleFiatType('deposit')"> NẠP</label><label class="flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold text-gray-500" id="lbl-withdraw"><input type="radio" name="fiatType" value="withdraw" class="hidden" onchange="app.toggleFiatType('withdraw')"> RÚT</label></div></div><div class="w-1/2"><label class="text-[10px] text-gray-400 block mb-1">Tỷ giá</label><input type="number" id="fiat-rate" value="25500" class="input-modern w-full rounded-lg px-3 py-2 text-neon-blue font-mono"></div></div>
                    <div><label class="text-[10px] text-gray-400 block mb-1">Số lượng</label><div class="flex"><input type="number" id="fiat-amount" class="input-modern w-full rounded-l-lg px-3 py-2 text-white font-mono"><select id="fiat-unit" class="bg-gray-800 text-white text-xs border border-gray-700 px-3 rounded-r-lg"><option value="VND">VND</option><option value="USDT">USDT</option></select></div></div>
                    
                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1">Phí dịch vụ</label>
                        <div class="flex">
                            <input type="number" id="fiat-fee" step="any" value="0" class="input-modern w-full rounded-l-lg px-3 py-2 text-red-400 font-mono">
                            <div class="bg-gray-800 text-gray-400 text-xs border border-gray-700 px-3 py-2 rounded-r-lg flex items-center">USDT</div>
                        </div>
                    </div>

                    <button type="button" onclick="app.saveFiatTransaction()" class="btn-neon btn-neon-blue w-full py-3 rounded-lg font-bold text-sm" id="btn-save-fiat">Xác nhận</button>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-di" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[70] backdrop-blur-md">
        <div class="glass-panel w-full max-w-4xl rounded-2xl border border-gray-700 h-[90vh] flex flex-col m-4 overflow-hidden">
            <div class="bg-black/60 px-6 py-4 flex justify-between items-center border-b border-gray-800 shrink-0"><h3 class="text-lg font-bold text-white">Dual Investment</h3><button onclick="app.closeModal('di')" class="text-gray-500 hover:text-white text-2xl">&times;</button></div>
            <div class="flex flex-col lg:flex-row h-full overflow-hidden">
                <div class="w-full lg:w-5/12 p-6 space-y-4 overflow-y-auto custom-scrollbar border-r border-gray-800">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-neon-blue font-bold block mb-1 flex justify-between"><span>Asset</span> <span id="di-live-price" class="text-neon-gold font-mono text-[9px]"></span></label>
                            <input type="text" id="di-asset" oninput="app.renderDICalculator()" class="input-modern w-full rounded-lg px-3 py-2 text-white uppercase font-bold" placeholder="BTC">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold block mb-1">Target Price</label>
                            <input type="number" id="di-target-price" oninput="app.renderDICalculator()" class="input-modern w-full rounded-lg px-3 py-2 text-neon-pink font-mono">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3"><label class="cursor-pointer border border-gray-700 rounded-lg p-2 bg-black/40" id="di-type-high"><input type="radio" name="diType" value="sell_high" checked class="hidden" onchange="app.renderDICalculator()"><div class="font-bold text-red-400 text-xs">Sell High</div></label><label class="cursor-pointer border border-gray-700 rounded-lg p-2 bg-black/40 opacity-50" id="di-type-low"><input type="radio" name="diType" value="buy_low" class="hidden" onchange="app.renderDICalculator()"><div class="font-bold text-emerald-400 text-xs">Buy Low</div></label></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="text-[10px] text-gray-400 block mb-1">Ngày bắt đầu</label><input type="date" id="di-start-date" onchange="app.renderDICalculator()" class="input-modern w-full rounded-lg px-2 py-2 text-white text-xs"></div><div><label class="text-[10px] text-gray-400 block mb-1">Thời hạn (Ngày)</label><input type="number" id="di-duration" oninput="app.renderDICalculator()" class="input-modern w-full rounded-lg px-2 py-2 text-white text-xs"></div></div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1 flex justify-between"><span>Số lượng</span> <span id="di-balance-display" class="text-[9px] text-neon-green cursor-pointer hover:underline" onclick="app.fillMaxDI()">Avail: 0</span></label>
                            <input type="number" id="di-amount" oninput="app.renderDICalculator()" class="input-modern w-full rounded-lg px-3 py-2 text-white font-bold font-mono">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">APR (%)</label>
                            <input type="number" id="di-apr" oninput="app.renderDICalculator()" class="input-modern w-full rounded-lg px-3 py-2 text-neon-gold font-bold font-mono">
                        </div>
                    </div>
                    <div class="mt-2 space-y-2"><div class="text-[10px] text-gray-500 font-bold uppercase">Kịch bản:</div><div class="flex gap-2"><div onclick="app.setDIScenario('below')" id="scen-below" class="neon-option flex-1 p-2 rounded-lg"><div class="text-[9px] text-gray-400">Giá &lt; Target</div><div class="text-xs font-bold text-white font-mono" id="val-below-main">...</div></div><div onclick="app.setDIScenario('above')" id="scen-above" class="neon-option flex-1 p-2 rounded-lg"><div class="text-[9px] text-gray-400">Giá &ge; Target</div><div class="text-xs font-bold text-white font-mono" id="val-above-main">...</div></div></div></div>
                    <button type="button" onclick="app.saveDITransaction()" class="w-full btn-neon btn-neon-pink font-bold py-3 rounded-lg mt-2 text-sm" id="btn-save-di">Xác nhận</button>
                </div>
                <div class="w-full lg:w-7/12 p-6 bg-black/20 flex flex-col"><div class="flex-1 relative w-full bg-black/40 rounded-xl border border-gray-800 p-2"><canvas id="diScenarioChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <div id="modal-trash" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[80] backdrop-blur-md">
        <div class="glass-panel w-full max-w-2xl rounded-2xl border border-gray-700 h-[80vh] flex flex-col m-4">
            <div class="bg-black/60 px-6 py-4 flex justify-between items-center shrink-0 border-b border-gray-800"><h3 class="text-lg font-bold text-red-500">Thùng rác</h3><button onclick="app.toggleTrashModal()" class="text-gray-400 hover:text-white text-xl">&times;</button></div>
            <div class="overflow-y-auto flex-1 p-4"><table class="w-full text-sm text-gray-400"><tbody id="trash-body"></tbody></table></div>
        </div>
    </div>
<div id="modal-quick-choice" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[90] backdrop-blur-sm">
        <div class="glass-panel w-80 rounded-2xl p-6 border border-neon-blue/30 transform transition-all scale-100">
            <h3 class="text-center text-lg font-bold text-white mb-1">Thao tác nhanh</h3>
            <p class="text-center text-neon-gold font-mono font-bold text-xl mb-6" id="qc-coin-name">BTC</p>
            
            <div class="space-y-3">
                <button onclick="app.quickAction('spot')" class="w-full btn-solid-gold py-3 rounded-lg font-bold text-black flex items-center justify-center gap-2">
                    <i class="fa-solid fa-right-left"></i> Giao dịch Spot
                </button>
                <button onclick="app.quickAction('di')" class="w-full btn-neon btn-neon-pink py-3 rounded-lg font-bold text-white flex items-center justify-center gap-2">
                    <i class="fa-solid fa-robot"></i> Dual Investment
                </button>
                <button onclick="document.getElementById('modal-quick-choice').classList.add('hidden'); document.getElementById('modal-quick-choice').classList.remove('flex')" class="w-full py-2 text-gray-500 text-xs hover:text-white mt-2">
                    Hủy bỏ
                </button>
            </div>
        </div>
    </div>

  <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Import đầy đủ các hàm
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDIPCgUjtiw-wIBFkxn6-Eiew_ixw3C75A",
          authDomain: "dcachovui1.firebaseapp.com",
          projectId: "dcachovui1",
          storageBucket: "dcachovui1.firebasestorage.app",
          messagingSenderId: "26819700346",
          appId: "1:26819700346:web:c15543c9ce92e0deb4fdc3"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);
        const provider = new GoogleAuthProvider();

        // --- SỬA LỖI TẠI ĐÂY: Thêm onAuthStateChanged vào danh sách ---
        window.firebaseServices = { 
            auth, 
            db, 
            provider, 
            signInWithPopup, 
            signOut, 
            doc, 
            setDoc, 
            getDoc, 
            onSnapshot, 
            setPersistence, 
            browserLocalPersistence,
            onAuthStateChanged // <--- Đã bổ sung hàm này
        };
    </script>

<script>
        const app = {
            data: {
                transactions: [], snapshots: [], prices: {}, user: null, 
                isPrivacyMode: false, sortOrder: 'desc', hideSmallAssets: false,
                diChartInstance: null, perfChartInstance: null,
                palette: ['#F0B90B', '#00F0FF', '#FF00FF', '#00FF9D', '#FF4D4D', '#8b5cf6', '#06b6d4', '#f97316', '#14b8a6', '#6366f1'],
                editingId: null,
                ticker: { speed: 0.5, pos: 0, isDragging: false, startX: 0, lastPos: 0, contentWidth: 0, reqId: null, coins: [] },
                quickCoin: null 
            },

            async init() {
                this.initDates();
                this.initTickerEvents();
                this.updateMarketData(true, true); 
                setInterval(() => this.updateMarketData(false, false), 5000);

                setTimeout(() => {
                    if (window.firebaseServices) {
                        const { auth } = window.firebaseServices;
                        // onAuthStateChanged tự động kiểm tra xem đã có phiên đăng nhập lưu trước đó chưa
                        window.firebaseServices.onAuthStateChanged(auth, (user) => {
                            if (user) { 
                                this.data.user = user; 
                                this.updateUIForLogin(true); 
                                this.setupRealtimeListener(user.uid); 
                            } else { 
                                this.data.user = null; 
                                this.updateUIForLogin(false); 
                                this.loadLocalData(); 
                            }
                        });
                    } else { this.loadLocalData(); }
                }, 500);
            },

            // --- AUTH LOGIC (Updated with Persistence) ---
            login() { 
                const { auth, provider, signInWithPopup, setPersistence, browserLocalPersistence } = window.firebaseServices; 
                
                // Thiết lập lưu phiên đăng nhập TRƯỚC khi gọi popup đăng nhập
                setPersistence(auth, browserLocalPersistence)
                    .then(() => {
                        return signInWithPopup(auth, provider);
                    })
                    .then(() => this.showToast('Đăng nhập thành công!', 'success'))
                    .catch((e) => this.showToast('Lỗi: ' + e.message, 'error')); 
            },

            logout() { 
                const { auth, signOut } = window.firebaseServices; 
                signOut(auth).then(() => { 
                    this.data.transactions=[]; 
                    this.renderAll(); 
                    location.reload(); 
                }); 
            },

            updateUIForLogin(isLoggedIn) {
                document.getElementById('btn-login').classList.toggle('hidden', isLoggedIn);
                document.getElementById('user-info').classList.toggle('hidden', !isLoggedIn);
                
                if(isLoggedIn && this.data.user) {
                    if(this.data.user.photoURL) document.getElementById('user-avatar').src = this.data.user.photoURL;
                    // Hiển thị Email
                    document.getElementById('user-email').innerText = this.data.user.email;
                }

                document.getElementById('sync-status').innerHTML = isLoggedIn ? '<i class="fa-solid fa-cloud text-neon-green"></i> Cloud Sync' : 'Offline Local';
                document.getElementById('sync-status').classList.toggle('text-neon-green', isLoggedIn);
            },

            // --- CÁC PHẦN CÒN LẠI GIỮ NGUYÊN ---
            setupRealtimeListener(uid) {
                const { db, doc, onSnapshot } = window.firebaseServices;
                onSnapshot(doc(db, "crypto_users", uid), (docSnap) => {
                    if (docSnap.exists()) { const d = docSnap.data(); this.data.transactions = d.transactions || []; this.data.snapshots = d.snapshots || []; } 
                    else { this.saveData(); }
                    this.renderAll(true); 
                });
            },
            
            // --- TICKER ---
            initTickerEvents() {
                const wrap = document.getElementById('ticker-wrapper');
                if(!wrap) return;
                wrap.addEventListener('mousedown', (e) => { this.data.ticker.isDragging = true; this.data.ticker.startX = e.pageX; this.data.ticker.lastPos = this.data.ticker.pos; wrap.classList.add('cursor-grabbing'); });
                window.addEventListener('mouseup', () => { this.data.ticker.isDragging = false; wrap.classList.remove('cursor-grabbing'); });
                window.addEventListener('mousemove', (e) => { if (!this.data.ticker.isDragging) return; const diff = e.pageX - this.data.ticker.startX; this.data.ticker.pos = this.data.ticker.lastPos + diff; });
                wrap.addEventListener('touchstart', (e) => { this.data.ticker.isDragging = true; this.data.ticker.startX = e.touches[0].pageX; this.data.ticker.lastPos = this.data.ticker.pos; });
                window.addEventListener('touchend', () => { this.data.ticker.isDragging = false; });
                window.addEventListener('touchmove', (e) => { if (!this.data.ticker.isDragging) return; const diff = e.touches[0].pageX - this.data.ticker.startX; this.data.ticker.pos = this.data.ticker.lastPos + diff; });
                this.animateTicker();
            },
            animateTicker() {
                const el = document.getElementById('ticker-content');
                if (el && this.data.ticker.contentWidth > 0) {
                    if (!this.data.ticker.isDragging) { this.data.ticker.pos -= this.data.ticker.speed; }
                    if (this.data.ticker.pos <= -this.data.ticker.contentWidth / 2) { this.data.ticker.pos += this.data.ticker.contentWidth / 2; }
                    if (this.data.ticker.pos > 0) { this.data.ticker.pos -= this.data.ticker.contentWidth / 2; }
                    el.style.transform = `translate3d(${this.data.ticker.pos}px, 0, 0)`;
                }
                requestAnimationFrame(() => this.animateTicker());
            },
            async updateTicker() {
                try {
                    const top = ["BTC","ETH","BNB","SOL","XRP","ADA","DOGE","TRX","AVAX","DOT","LINK","MATIC","LTC","UNI"];
                    const r = await fetch('https://api.binance.com/api/v3/ticker/24hr'); const d = await r.json();
                    let html = '';
                    top.forEach(s => { 
                        const i=d.find(x=>x.symbol===s+'USDT'); 
                        if(i) { html += `<div onclick="app.openQuickChoice('${s}')" class="inline-flex flex-col items-center justify-center px-6 border-r border-white/10 h-full cursor-pointer hover:bg-white/10 transition select-none"><span class="font-bold text-white text-[10px] md:text-xs pointer-events-none">${s}</span><div class="flex gap-2 pointer-events-none"><span class="text-gray-300 text-[10px] md:text-xs font-mono">$${parseFloat(i.lastPrice) > 1 ? parseFloat(i.lastPrice).toLocaleString() : parseFloat(i.lastPrice)}</span><span class="${parseFloat(i.priceChangePercent)>=0?'text-neon-green':'text-neon-red'} text-[10px] font-bold">${parseFloat(i.priceChangePercent).toFixed(2)}%</span></div></div>`; }
                    });
                    const el = document.getElementById('ticker-content');
                    if(el) { el.innerHTML = html + html; this.data.ticker.contentWidth = el.scrollWidth; }
                } catch(e){}
            },
            manualRefresh() {
                const btn = document.getElementById('refresh-icon'); btn.classList.add('fa-spin');
                this.updateMarketData(false, true).then(() => { setTimeout(() => btn.classList.remove('fa-spin'), 500); this.showToast('Đã làm mới dữ liệu & biểu đồ', 'success'); });
            },
            openQuickChoice(coin) { this.data.quickCoin = coin; document.getElementById('qc-coin-name').innerText = coin; document.getElementById('modal-quick-choice').classList.remove('hidden'); document.getElementById('modal-quick-choice').classList.add('flex'); },
            quickAction(type) {
                document.getElementById('modal-quick-choice').classList.add('hidden'); document.getElementById('modal-quick-choice').classList.remove('flex');
                if(type === 'spot') { this.openAddTransactionModal(); this.switchModalTab('spot'); document.getElementById('spot-coin').value = this.data.quickCoin; this.updateSpotInfo(); } 
                else if (type === 'di') { this.openDIModal(); document.getElementById('di-asset').value = this.data.quickCoin; this.renderDICalculator(); }
            },

            loadLocalData() { this.data.transactions = JSON.parse(localStorage.getItem('crypto_dca_data_v2')) || []; this.data.snapshots = JSON.parse(localStorage.getItem('crypto_snapshots_v2')) || []; this.renderAll(true); },
            saveData() {
                localStorage.setItem('crypto_dca_data_v2', JSON.stringify(this.data.transactions));
                localStorage.setItem('crypto_snapshots_v2', JSON.stringify(this.data.snapshots));
                if (this.data.user && window.firebaseServices) {
                    const { db, doc, setDoc } = window.firebaseServices;
                    setDoc(doc(db, "crypto_users", this.data.user.uid), { transactions: this.data.transactions, snapshots: this.data.snapshots, lastUpdated: new Date().toISOString() }, { merge: true });
                }
                this.renderAll(false);
            },
            renderAll(shouldDrawChart = false) { this.renderPortfolio(shouldDrawChart); this.renderHistory(); this.renderTrash(); this.renderDIView(); },
            async updateMarketData(init=false, drawChart=false) { await this.fetchPrices(); await this.updateTicker(); this.renderPortfolio(drawChart); if(init) this.renderHistory(); this.renderDIView(); },
            async fetchPrices() { try { const r=await fetch('https://api.binance.com/api/v3/ticker/price'); (await r.json()).forEach(i=>this.data.prices[i.symbol]=parseFloat(i.price)); this.data.prices['USDTUSDT']=1; } catch(e){} },
            getRate(s) { return s==='USDT'?1:(this.data.prices[s+'USDT']||0); },
            getCoinIcon(s) { return s ? `https://raw.githubusercontent.com/spothq/cryptocurrency-icons/master/128/color/${s.toLowerCase()}.png` : ''; },
            formatNumber(n,c=false) { if(n===undefined||isNaN(n)) return '0'; n=parseFloat(n); return c ? n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}) : (Math.abs(n)>=1 ? n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}) : (n===0?'0.00':n.toFixed(6))); },

            calculatePortfolio() {
                const assets = {}; let usdtBalance=0, totalInvested=0, realizedPnL=0;
                const active = this.data.transactions.filter(t=>!t.deleted);
                active.sort((a,b)=>new Date(a.date)-new Date(b.date));
                active.forEach(tx => {
                    const amt = parseFloat(tx.amount)||0, total=parseFloat(tx.total)||0, fee=parseFloat(tx.fee)||0;
                    if(tx.type==='deposit') { usdtBalance += (amt - fee); totalInvested += (amt - fee); }
                    else if(tx.type==='withdraw') { usdtBalance -= (amt + fee); totalInvested -= (amt + fee); }
                    else if(tx.type==='buy') { if(!assets[tx.coin]) assets[tx.coin]={amount:0,locked:0,cost:0}; assets[tx.coin].amount += amt; assets[tx.coin].cost += (total + fee); usdtBalance -= (total + fee); }
                    else if(tx.type==='sell') { if(assets[tx.coin]) { const avg = assets[tx.coin].cost/(assets[tx.coin].amount+assets[tx.coin].locked || 1); const proceeds = total - fee; realizedPnL += proceeds - (amt * avg); assets[tx.coin].amount -= amt; assets[tx.coin].cost -= (amt*avg); usdtBalance += proceeds; } }
                    else if(tx.type==='di_entry') { if(tx.diType==='sell_high') { if(!assets[tx.coin]) assets[tx.coin]={amount:0,locked:0,cost:0}; assets[tx.coin].amount -= amt; assets[tx.coin].locked += amt; } else { usdtBalance -= amt; if(!assets['USDT']) assets['USDT']={amount:0,locked:0,cost:0}; assets['USDT'].locked += amt; } }
                    else if(tx.type==='di_settle') { const p = active.find(x=>x.id===tx.parentDiId); if(p) { const res = parseFloat(tx.resultAmount)||0; if(p.diType==='sell_high') { assets[p.coin].locked -= p.amount; const avg = assets[p.coin].cost / (assets[p.coin].amount + assets[p.coin].locked + p.amount || 1); if(tx.resultAsset === 'USDT') { realizedPnL += (res - (p.amount * avg)); assets[p.coin].cost -= (p.amount * avg); usdtBalance += res; } else { assets[p.coin].amount += res; } } else { assets['USDT'].locked -= p.amount; if(tx.resultAsset === 'USDT') { realizedPnL += (res - p.amount); usdtBalance += res; } else { if(!assets[tx.resultAsset]) assets[tx.resultAsset]={amount:0,locked:0,cost:0}; assets[tx.resultAsset].amount += res; assets[tx.resultAsset].cost += p.amount; } } } }
                });
                return { assets, usdtBalance, totalInvested, realizedPnL };
            },

            renderPortfolio(shouldDrawChart) {
                const { assets, usdtBalance, totalInvested, realizedPnL } = this.calculatePortfolio();
                const tbody = document.getElementById('assets-table-body'); if(!tbody) return; tbody.innerHTML = '';
                const safeUsdtBalance = Math.max(0, usdtBalance);
                document.getElementById('usdt-available').innerText = this.formatNumber(safeUsdtBalance, true);
                let totalLocked = assets['USDT']?assets['USDT'].locked:0; let totalVal = safeUsdtBalance + totalLocked; let costBasis = safeUsdtBalance + totalLocked;
                const labels=['USDT'], dataC=[safeUsdtBalance+totalLocked], colors=['#0ECB81'];
                tbody.innerHTML += `<tr class="border-b border-gray-800 hover:bg-white/5"><td class="py-4 px-2 flex items-center gap-3"><img src="${this.getCoinIcon('USDT')}" class="w-6 h-6 rounded-full"><div><div class="font-bold text-white text-xs">USDT</div></div></td><td class="py-4 px-2 text-right font-mono text-white text-xs">${this.formatNumber(safeUsdtBalance)}${totalLocked>0?`<br><span class="text-[9px] text-neon-gold"><i class="fa-solid fa-lock"></i> ${this.formatNumber(totalLocked)}</span>`:''}</td><td class="hidden md:table-cell"></td><td></td><td class="text-right font-bold font-mono text-white text-xs">${this.formatMoneyPrivately(safeUsdtBalance+totalLocked,true)}</td><td></td></tr>`;
                let idx=0;
                Object.keys(assets).forEach(coin => {
                    if(coin==='USDT') return;
                    const d = assets[coin]; const total = d.amount+d.locked; if(total<=0.000001) return;
                    const price = this.getRate(coin); const val = total*price;
                    if(this.data.hideSmallAssets && val < 1) return;
                    totalVal += val; costBasis += d.cost;
                    if(val>1) { labels.push(coin); dataC.push(val); colors.push(this.data.palette[idx++%this.data.palette.length]); }
                    const avg = d.cost/total; const pnl = val - d.cost; const pct = d.cost>0?(pnl/d.cost*100):0;
                    tbody.innerHTML += `<tr class="border-b border-gray-800 hover:bg-white/5"><td class="py-4 px-2 flex items-center gap-3"><img src="${this.getCoinIcon(coin)}" onerror="this.src='https://via.placeholder.com/30'" class="w-6 h-6 rounded-full"><span class="font-bold text-xs md:text-sm">${coin}</span></td><td class="py-4 px-2 text-right font-mono text-white text-xs">${this.formatNumber(d.amount)}${d.locked>0?`<br><span class="text-[9px] text-neon-gold"><i class="fa-solid fa-lock"></i> ${this.formatNumber(d.locked)}</span>`:''}</td><td class="py-4 px-2 text-right text-gray-400 font-mono text-xs hide-on-mobile">${this.formatNumber(avg)}</td><td class="py-4 px-2 text-right text-neon-blue font-mono text-xs">${this.formatNumber(price)}</td><td class="py-4 px-2 text-right font-bold text-white font-mono text-xs">${this.formatMoneyPrivately(val,true)}</td><td class="py-4 px-2 text-right font-mono font-bold text-xs ${pnl>=0?'text-neon-green':'text-neon-red'}">${pnl>=0?'+':''}${this.formatMoneyPrivately(pnl,true)}<br><span class="text-[9px] opacity-80">(${pct.toFixed(2)}%)</span></td></tr>`;
                });
                const safeTotalVal = Math.max(0, totalVal);
                document.getElementById('total-balance').innerText = this.formatMoneyPrivately(safeTotalVal, true);
                document.getElementById('total-invested').innerText = this.formatMoneyPrivately(totalInvested, true);
                const uPnl = safeTotalVal - costBasis; 
                document.getElementById('unrealized-pnl').innerText = `${uPnl>=0?'+':''}${this.formatMoneyPrivately(uPnl,true)}`;
                document.getElementById('unrealized-pnl').className = `text-xl md:text-3xl font-bold font-mono ${uPnl>=0?'text-neon-green':'text-neon-red'}`;
                document.getElementById('unrealized-pnl-pct').innerText = `${costBasis>0?(uPnl/costBasis*100).toFixed(2):0}%`;
                document.getElementById('realized-pnl').innerText = `${realizedPnL>=0?'+':''}${this.formatMoneyPrivately(realizedPnL,true)}`;
                document.getElementById('realized-pnl').className = `text-xl md:text-3xl font-bold font-mono ${realizedPnL>=0?'text-neon-pink':'text-neon-red'}`;
                if (shouldDrawChart) { this.renderChart(labels, dataC, colors); this.renderPerfChart(); }
                this.checkSnapshot(safeTotalVal);
            },
            renderChart(l, d, c) { const ctx = document.getElementById('portfolioChart').getContext('2d'); if(this.chartInstance) this.chartInstance.destroy(); this.chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels:l, datasets: [{ data:d, backgroundColor:c, borderWidth:0 }] }, options: { plugins:{legend:{display:false}}, cutout:'80%' } }); document.getElementById('chart-legend').innerHTML = l.map((x,i)=>`<div class="flex justify-between text-xs p-1"><span style="color:${c[i]}">● ${x}</span><span class="text-white">${Math.round(d[i]).toLocaleString()}</span></div>`).join(''); },
            checkSnapshot(v) { if(v<=0) return; const t=new Date().toISOString().slice(0,10); if(!this.data.snapshots.find(s=>s.date===t)) { this.data.snapshots.push({date:t,value:v}); if(this.data.snapshots.length>30) this.data.snapshots.shift(); this.saveData(); } },
            renderPerfChart() { const ctx = document.getElementById('performanceChart').getContext('2d'); if(this.perfChartInstance) this.perfChartInstance.destroy(); this.perfChartInstance = new Chart(ctx, { type: 'line', data: { labels:this.data.snapshots.map(s=>s.date.slice(5)), datasets: [{ data:this.data.snapshots.map(s=>s.value), borderColor:'#00FF9D', tension:0.4, pointRadius:0 }] }, options: { plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'rgba(255,255,255,0.05)'}}} } }); },
            resetHistoryFilter() { document.getElementById('hist-filter-type').value = 'all'; document.getElementById('hist-sort').value = 'desc'; document.getElementById('hist-date-start').value = ''; document.getElementById('hist-date-end').value = ''; this.renderHistory(); },
            renderHistory() {
                const tbody = document.getElementById('history-table-body'); if(!tbody) return; tbody.innerHTML = '';
                const typeF = document.getElementById('hist-filter-type') ? document.getElementById('hist-filter-type').value : 'all';
                const sortF = document.getElementById('hist-sort') ? document.getElementById('hist-sort').value : 'desc';
                const startD = document.getElementById('hist-date-start') ? document.getElementById('hist-date-start').value : '';
                const endD = document.getElementById('hist-date-end') ? document.getElementById('hist-date-end').value : '';
                let list = this.data.transactions.filter(t=>!t.deleted && !t.type.includes('di_'));
                if(typeF === 'buy_sell') list = list.filter(t => t.type === 'buy' || t.type === 'sell');
                if(typeF === 'fiat') list = list.filter(t => t.type === 'deposit' || t.type === 'withdraw');
                if(startD) list = list.filter(t => new Date(t.date) >= new Date(startD));
                if(endD) list = list.filter(t => new Date(t.date) <= new Date(endD + 'T23:59:59'));
                list.sort((a,b) => sortF === 'desc' ? new Date(b.date) - new Date(a.date) : new Date(a.date) - new Date(b.date));
                list.slice(0,50).forEach(t => {
                    let c='', d='', v='';
                    if(t.type==='buy') { c='text-neon-green'; d='BUY '+t.coin; v=`+${this.formatNumber(t.amount)}`; }
                    else if(t.type==='sell') { c='text-neon-red'; d='SELL '+t.coin; v=`-${this.formatNumber(t.amount)}`; }
                    else if(t.type==='deposit') { c='text-neon-blue'; d='DEPOSIT'; v=`+${this.formatNumber(t.amount)}`; }
                    else { c='text-gray-400'; d='WITHDRAW'; v=`-${this.formatNumber(t.amount)}`; }
                    const feeText = t.fee > 0 ? `<div class="text-[9px] text-gray-500">Fee: ${this.formatNumber(t.fee)}</div>` : '';
                    tbody.innerHTML += `<tr class="border-b border-gray-800 hover:bg-white/5"><td class="p-3 text-gray-500 text-[10px] font-mono">${t.date.slice(5,10)}</td><td class="p-3 ${c} font-bold text-xs">${t.type.toUpperCase()}</td><td class="p-3 font-bold text-xs">${d}</td><td class="p-3 text-right text-xs text-gray-400">${this.formatNumber(t.price||t.rate)}</td><td class="p-3 text-right text-xs font-bold ${c}">${v}</td><td class="p-3 text-right text-xs text-gray-500">${this.formatNumber(t.total||t.amount)}${feeText}</td><td class="p-3 text-center flex items-center justify-center gap-2"><button onclick="app.editTransaction('${t.id}')"><i class="fa-solid fa-pen text-neon-blue hover:text-white"></i></button><button onclick="app.softDel('${t.id}')"><i class="fa-solid fa-trash text-gray-600 hover:text-red-500"></i></button></td></tr>`;
                });
            },
            exportToExcel() {
                const BOM = "\uFEFF"; let csv = BOM + "Ngày,Loại,Coin,Giá,Số Lượng,Tổng/Kết Quả,Phí\n";
                let list = this.data.transactions.filter(t => !t.deleted); list.sort((a,b) => new Date(b.date) - new Date(a.date));
                list.forEach(t => {
                    let type = t.type.toUpperCase(), coin = t.coin || t.resultAsset || 'USDT';
                    let price = t.price || t.rate || t.targetPrice || '-', amount = t.amount || '-', total = t.total || t.resultAmount || '-', fee = t.fee || 0;
                    csv += `${t.date?t.date.slice(0,16):''},${type},${coin},${price},${amount},${total},${fee}\n`;
                });
                const url = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" }));
                const link = document.createElement("a"); link.href = url; link.download = `crypto_data_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            },
            renderTrash() { const el = document.getElementById('trash-body'), count = document.getElementById('trashCount'), del = this.data.transactions.filter(t=>t.deleted); if(count) { count.innerText = del.length; count.classList.toggle('hidden', del.length===0); } if(el) el.innerHTML = del.length===0 ? '<tr><td colspan="3" class="text-center p-4 text-gray-500">Trống</td></tr>' : del.map(t=>`<tr class="border-b border-gray-800"><td class="p-2 text-xs text-white">${t.type.toUpperCase()} ${t.coin||''}</td><td class="p-2 text-xs">${this.formatNumber(t.amount)}</td><td class="p-2 text-right"><button onclick="app.restore('${t.id}')" class="text-neon-green mr-2"><i class="fa-solid fa-rotate-left"></i></button><button onclick="app.hardDelete('${t.id}')" class="text-red-500"><i class="fa-solid fa-times"></i></button></td></tr>`).join(''); },
            toggleTrashModal() { const el=document.getElementById('modal-trash'); el.classList.toggle('hidden'); el.classList.toggle('flex'); if(!el.classList.contains('hidden')) this.renderTrash(); },
            softDel(id) { if(confirm("Chuyển vào thùng rác?")) { const t=this.data.transactions.find(x=>x.id===id); if(t){t.deleted=true;this.saveData();this.showToast('Đã chuyển vào thùng rác','info');} } },
            restore(id) { const t=this.data.transactions.find(x=>x.id===id); if(t){t.deleted=false;this.saveData();this.toggleTrashModal();this.toggleTrashModal();this.showToast('Đã khôi phục','success');} },
            hardDelete(id) { if(confirm("Xóa vĩnh viễn?")) { this.data.transactions=this.data.transactions.filter(x=>x.id!==id); this.saveData(); this.renderTrash(); } },
            editTransaction(id) {
                const t = this.data.transactions.find(x => x.id === id); if (!t) return; this.data.editingId = id; const dateVal = t.date ? t.date.slice(0, 16) : '';
                if (t.type === 'di_entry') { document.getElementById('di-asset').value = t.coin; document.getElementById('di-target-price').value = t.targetPrice; document.getElementById('di-amount').value = t.amount; document.getElementById('di-apr').value = t.apr; document.getElementById('di-duration').value = t.duration; document.getElementById('di-start-date').value = t.date.slice(0,10); document.querySelector(`input[name="diType"][value="${t.diType}"]`).checked = true; this.openDIModal(); } 
                else { this.openAddTransactionModal(); this.data.editingId = id; if (t.type === 'buy' || t.type === 'sell') { this.switchModalTab('spot'); document.querySelector(`input[name="spotType"][value="${t.type}"]`).checked = true; this.toggleSpotType(t.type); document.getElementById('spot-coin').value = t.coin; document.getElementById('spot-price').value = t.price; document.getElementById('spot-amount').value = t.amount; document.getElementById('spot-total').value = t.total; document.getElementById('spot-date').value = dateVal; document.getElementById('spot-fee').value = t.fee || 0; this.updateSpotInfo(); } else if (t.type === 'deposit' || t.type === 'withdraw') { this.switchModalTab('fiat'); document.querySelector(`input[name="fiatType"][value="${t.type}"]`).checked = true; this.toggleFiatType(t.type); document.getElementById('fiat-rate').value = t.rate || 25500; document.getElementById('fiat-unit').value = 'USDT'; document.getElementById('fiat-amount').value = t.amount; document.getElementById('fiat-fee').value = t.fee || 0; } } this.showToast('Đang chỉnh sửa...', 'info');
            },
            showToast(m, t='info') { const c=document.getElementById('toast-container'), e=document.createElement('div'); e.className=`toast ${t}`; e.innerHTML=`<span class="text-sm font-bold">${m}</span>`; c.appendChild(e); setTimeout(()=>{e.remove()},3000); },
            togglePrivacy() { this.data.isPrivacyMode = !this.data.isPrivacyMode; this.renderPortfolio(); },
            formatMoneyPrivately(v,c=false) { if(this.data.isPrivacyMode) return '******'; return c ? `$${this.formatNumber(v,true)}` : this.formatNumber(v); },
            initDates() { const s = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0,16); if(document.getElementById('spot-date')) document.getElementById('spot-date').value = s; if(document.getElementById('di-start-date')) document.getElementById('di-start-date').value = s.slice(0,10); },
            // === MISSING DI FUNCTIONS RESTORED BELOW ===
            renderDIView() { const ac = document.getElementById('di-list-active'), hi = document.getElementById('di-list-history'); if(!ac || !hi) return; ac.innerHTML = ''; hi.innerHTML = ''; const activeDI = this.data.transactions.filter(t => t.type === 'di_entry' && !t.deleted && !t.settled); activeDI.forEach(d => { const price = this.getRate(d.coin); const isWinCondition = d.diType === 'sell_high' ? (price >= d.targetPrice) : (price <= d.targetPrice); ac.innerHTML += `<div class="glass-panel p-4 rounded-xl border-l-4 ${d.diType==='sell_high'?'border-red-500':'border-emerald-500'} mb-4"><div class="flex justify-between items-start mb-2"><div><span class="font-bold text-white text-sm block">${d.coin}</span><span class="${d.diType==='sell_high'?'text-red-400':'text-emerald-400'} font-bold text-xs">${d.diType.replace('_',' ').toUpperCase()}</span></div><div class="flex gap-2"><button onclick="app.editTransaction('${d.id}')" class="p-1"><i class="fa-solid fa-pen text-neon-blue hover:text-white text-sm"></i></button><button onclick="app.softDel('${d.id}')" class="p-1"><i class="fa-solid fa-trash text-gray-500 hover:text-red-500 text-sm"></i></button></div></div><div class="grid grid-cols-2 gap-2 text-[10px] text-gray-400"><div class="flex flex-col"><span>Target</span><b class="text-white">${d.targetPrice}</b></div><div class="flex flex-col text-right"><span>Current</span><b class="${isWinCondition ? 'text-neon-gold' : 'text-white'}">${this.formatNumber(price)}</b></div><div class="flex flex-col"><span>APR</span><b class="text-neon-gold">${d.apr}%</b></div><div class="flex flex-col text-right"><span>Amount</span><b class="text-white">${this.formatNumber(d.amount)}</b></div></div><div class="flex gap-2 mt-3 justify-end border-t border-gray-700 pt-2"><div class="text-[9px] text-gray-500 flex items-center mr-auto">${d.date.slice(5,10)} + ${d.duration}d</div><button onclick="app.settleDI('${d.id}', false)" class="text-[10px] bg-gray-800 text-gray-300 px-3 py-1.5 rounded hover:bg-gray-700 font-bold">Fail</button><button onclick="app.settleDI('${d.id}', true)" class="text-[10px] bg-neon-gold text-black px-3 py-1.5 rounded hover:bg-yellow-400 font-bold">Win</button></div></div>`; }); const sortF = document.getElementById('di-hist-sort')?document.getElementById('di-hist-sort').value:'desc'; const historyDI = this.data.transactions.filter(t => t.type === 'di_settle' && !t.deleted); historyDI.sort((a,b) => sortF === 'desc' ? new Date(b.date) - new Date(a.date) : new Date(a.date) - new Date(b.date)); historyDI.forEach(h => { const p = this.data.transactions.find(t => t.id === h.parentDiId); if(!p) return; hi.innerHTML += `<tr class="border-b border-gray-800 hover:bg-white/5"><td class="p-3"><div class="font-bold text-white text-xs">${p.coin}</div><div class="text-[9px] text-gray-500">${p.diType.replace('_',' ').toUpperCase()}</div></td><td class="p-3 text-right"><div class="font-bold text-xs text-neon-gold">+${this.formatNumber(h.resultAmount)} <span class="text-[9px] text-gray-400">${h.resultAsset}</span></div><div class="text-[9px] text-gray-500">${h.date.slice(0,10)}</div></td><td class="p-3 text-right w-10"><button onclick="app.softDel('${h.id}')" title="Xóa lịch sử"><i class="fa-solid fa-trash text-gray-600 hover:text-red-500 text-xs"></i></button></td></tr>`; }); },
            openDIModal() { document.getElementById('modal-di').classList.remove('hidden'); document.getElementById('modal-di').classList.add('flex'); this.renderDICalculator(); },
            renderDICalculator() { const amount = parseFloat(document.getElementById('di-amount').value) || 0; const apr = parseFloat(document.getElementById('di-apr').value) || 0; const duration = parseFloat(document.getElementById('di-duration').value) || 1; const target = parseFloat(document.getElementById('di-target-price').value) || 0; const type = document.querySelector('input[name="diType"]:checked').value; const asset = (document.getElementById('di-asset').value || 'COIN').toUpperCase(); const coin = document.getElementById('di-asset').value.toUpperCase(); const price = this.getRate(coin); document.getElementById('di-live-price').innerText = price > 0 ? `Live: ${this.formatNumber(price)}` : ''; let bal = 0; if(type === 'sell_high') bal = this.getAssetBalance(coin); else bal = this.data.usdtBalance || this.getAssetBalance('USDT'); document.getElementById('di-balance-display').innerText = `Avail: ${this.formatNumber(bal)} ${type==='sell_high'?coin:'USDT'}`; document.getElementById('di-type-high').style.opacity = type === 'sell_high' ? '1' : '0.5'; document.getElementById('di-type-high').style.borderColor = type === 'sell_high' ? '#FF4D4D' : '#333'; document.getElementById('di-type-low').style.opacity = type === 'buy_low' ? '1' : '0.5'; document.getElementById('di-type-low').style.borderColor = type === 'buy_low' ? '#00FF9D' : '#333'; const interest = amount * (apr/100) * (duration/365); const totalAsset = amount + interest; if(type === 'sell_high') { document.getElementById('val-below-main').innerHTML = `${this.formatNumber(totalAsset, false)} <span class="text-neon-gold text-[10px]">${asset}</span>`; document.getElementById('val-above-main').innerHTML = `${this.formatNumber(totalAsset * target, false)} <span class="text-neon-green text-[10px]">USDT</span>`; } else { document.getElementById('val-below-main').innerHTML = `${this.formatNumber(totalAsset / target, false)} <span class="text-neon-gold text-[10px]">${asset}</span>`; document.getElementById('val-above-main').innerHTML = `${this.formatNumber(totalAsset, false)} <span class="text-neon-green text-[10px]">USDT</span>`; } },
            saveDITransaction() { const coin = document.getElementById('di-asset').value.toUpperCase(); if(!coin) return alert("Vui lòng nhập tên Coin!"); const type = document.querySelector('input[name="diType"]:checked').value; const amount = parseFloat(document.getElementById('di-amount').value); const isSellHigh = type === 'sell_high'; const checkCoin = isSellHigh ? coin : 'USDT'; let available = this.getAssetBalance(checkCoin); if(this.data.editingId) { const oldTx = this.data.transactions.find(t=>t.id===this.data.editingId); if(oldTx && !oldTx.deleted) { if(oldTx.diType === 'sell_high' && isSellHigh && oldTx.coin === coin) available += oldTx.amount; if(oldTx.diType === 'buy_low' && !isSellHigh) available += oldTx.amount; } } if(available < amount) return alert(`Số dư không đủ! Có: ${this.formatNumber(available)} ${checkCoin}, Cần: ${this.formatNumber(amount)}`); const payload = { type: 'di_entry', diType: type, coin: coin, targetPrice: parseFloat(document.getElementById('di-target-price').value), amount: amount, apr: parseFloat(document.getElementById('di-apr').value), duration: parseFloat(document.getElementById('di-duration').value), date: document.getElementById('di-start-date').value, settled: false }; if (this.data.editingId) { const idx = this.data.transactions.findIndex(x => x.id === this.data.editingId); if(idx !== -1) { this.data.transactions[idx] = { ...this.data.transactions[idx], ...payload }; this.showToast('Cập nhật thành công', 'success'); } } else { this.pushTx(payload); } this.saveData(); this.closeModal('di'); this.data.editingId = null; },
            settleDI(id, isWin) { const di = this.data.transactions.find(t => t.id === id); if(!di) return; const actionText = isWin ? "KHỚP LỆNH (Win)" : "KHÔNG KHỚP (Fail)"; if(!confirm(`Xác nhận kết quả: ${actionText}?`)) return; di.settled = true; const interest = di.amount * (di.apr/100) * (di.duration/365); let resultAmount = 0, resultAsset = ''; if(di.diType === 'sell_high') { if(isWin) { resultAmount = (di.amount + interest) * di.targetPrice; resultAsset = 'USDT'; } else { resultAmount = di.amount + interest; resultAsset = di.coin; } } else { if(isWin) { resultAmount = (di.amount + interest) / di.targetPrice; resultAsset = di.coin; } else { resultAmount = di.amount + interest; resultAsset = 'USDT'; } } this.data.transactions.push({ id: crypto.randomUUID(), type: 'di_settle', parentDiId: id, date: new Date().toISOString(), resultAmount: resultAmount, resultAsset: resultAsset, deleted: false }); this.saveData(); this.renderDIView(); this.showToast('Đã tất toán thành công!', 'success'); },
            // === END DI FUNCTIONS ===
            saveSpotTransaction() { const type=document.querySelector('input[name="spotType"]:checked').value; const coin=document.getElementById('spot-coin').value.toUpperCase(); if(!coin) return alert("Nhập coin!"); const isBuy = type === 'buy'; const total = parseFloat(document.getElementById('spot-total').value); const amount = parseFloat(document.getElementById('spot-amount').value); const fee = parseFloat(document.getElementById('spot-fee').value) || 0; const checkCoin = isBuy ? 'USDT' : coin; const checkAmount = isBuy ? total + fee : amount; let available = this.getAssetBalance(checkCoin); if(this.data.editingId) { const oldTx = this.data.transactions.find(t=>t.id===this.data.editingId); if(oldTx && !oldTx.deleted) { if(oldTx.type === 'buy' && isBuy) available += (oldTx.total + (oldTx.fee||0)); if(oldTx.type === 'sell' && !isBuy && oldTx.coin === coin) available += oldTx.amount; } } if(available < checkAmount) return alert(`Số dư không đủ! Có: ${this.formatNumber(available)} ${checkCoin}, Cần: ${this.formatNumber(checkAmount)}`); const payload = { type, coin, price:parseFloat(document.getElementById('spot-price').value), amount:amount, total:total, fee: fee, date:document.getElementById('spot-date').value }; if (this.data.editingId) { const idx = this.data.transactions.findIndex(x => x.id === this.data.editingId); if(idx !== -1) { this.data.transactions[idx] = { ...this.data.transactions[idx], ...payload }; this.saveData(); this.closeModal('transaction'); this.showToast('Cập nhật thành công', 'success'); } } else { this.pushTx(payload); } this.data.editingId = null; },
            saveFiatTransaction() { const type=document.querySelector('input[name="fiatType"]:checked').value, amt=parseFloat(document.getElementById('fiat-amount').value), r=parseFloat(document.getElementById('fiat-rate').value), u=document.getElementById('fiat-unit').value, fee=parseFloat(document.getElementById('fiat-fee').value) || 0; if(!amt) return alert("Nhập số lượng!"); const realAmount = u==='VND'?amt/r:amt; if(type === 'withdraw') { let available = this.getAssetBalance('USDT'); if(this.data.editingId) { const oldTx = this.data.transactions.find(t=>t.id===this.data.editingId); if(oldTx && !oldTx.deleted && oldTx.type === 'withdraw') available += (oldTx.amount + (oldTx.fee||0)); } if(available < realAmount + fee) return alert(`Số dư không đủ! Có: ${this.formatNumber(available)} USDT, Cần: ${this.formatNumber(realAmount + fee)}`); } const payload = { type, amount: realAmount, fee: fee, rate:r, date:new Date().toISOString() }; if (this.data.editingId) { const idx = this.data.transactions.findIndex(x => x.id === this.data.editingId); if(idx !== -1) { this.data.transactions[idx] = { ...this.data.transactions[idx], ...payload }; this.saveData(); this.closeModal('transaction'); this.showToast('Cập nhật thành công', 'success'); } } else { this.pushTx(payload); } this.data.editingId = null; },
            pushTx(d) { this.data.transactions.push({ id: crypto.randomUUID(), ...d, deleted: false }); this.saveData(); this.closeModal('transaction'); this.showToast('Lưu thành công', 'success'); },
            toggleSmallAssets() { this.data.hideSmallAssets = document.getElementById('hide-small-assets').checked; this.renderPortfolio(); },
            openAddTransactionModal() { this.data.editingId = null; document.getElementById('spot-coin').value = ''; document.getElementById('spot-price').value = ''; document.getElementById('spot-amount').value = ''; document.getElementById('spot-total').value = ''; document.getElementById('spot-fee').value = '0'; document.getElementById('fiat-fee').value = '0'; document.getElementById('modal-transaction').classList.remove('hidden'); document.getElementById('modal-transaction').classList.add('flex'); },
            closeModal(n) { document.getElementById(`modal-${n}`).classList.add('hidden'); document.getElementById(`modal-${n}`).classList.remove('flex'); this.data.editingId = null; },
            switchTab(t) { ['portfolio','history','di'].forEach(x=>{document.getElementById(`view-${x}`).classList.add('hidden');document.getElementById(`tab-${x}`).className='tab-inactive py-3 px-3 md:px-4 font-bold text-xs md:text-sm tracking-wide transition uppercase whitespace-nowrap'}); document.getElementById(`view-${t}`).classList.remove('hidden'); document.getElementById(`tab-${t}`).className='tab-active py-3 px-3 md:px-4 font-bold text-xs md:text-sm tracking-wide transition uppercase whitespace-nowrap'; if(t==='di') this.renderDIView(); },
            switchModalTab(t) { if(t==='spot'){document.getElementById('form-spot').classList.remove('hidden');document.getElementById('form-fiat').classList.add('hidden'); document.getElementById('modal-tab-spot').className="flex-1 py-4 text-sm font-bold text-neon-gold border-b-2 border-neon-gold uppercase"; document.getElementById('modal-tab-fiat').className="flex-1 py-4 text-sm font-bold text-gray-500 uppercase";}else{document.getElementById('form-spot').classList.add('hidden');document.getElementById('form-fiat').classList.remove('hidden'); document.getElementById('modal-tab-spot').className="flex-1 py-4 text-sm font-bold text-gray-500 uppercase"; document.getElementById('modal-tab-fiat').className="flex-1 py-4 text-sm font-bold text-neon-blue border-b-2 border-neon-blue uppercase";} },
            toggleSpotType(type) { if(type === 'buy') { document.getElementById('lbl-buy').className = "flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold bg-emerald-600 text-white"; document.getElementById('lbl-sell').className = "flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold text-gray-500"; document.getElementById('btn-save-spot').innerText = "MUA"; document.getElementById('btn-save-spot').className = "btn-solid-gold w-full py-3 rounded-lg mt-4 text-sm font-bold uppercase"; document.getElementById('spot-fee-unit').innerText = "Coin"; } else { document.getElementById('lbl-buy').className = "flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold text-gray-500"; document.getElementById('lbl-sell').className = "flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold bg-red-600 text-white"; document.getElementById('btn-save-spot').innerText = "BÁN"; document.getElementById('btn-save-spot').className = "w-full py-3 rounded-lg mt-4 text-sm font-bold uppercase bg-gradient-to-r from-red-600 to-red-400 text-white"; document.getElementById('spot-fee-unit').innerText = "USDT"; } this.updateSpotInfo(); },
            toggleFiatType(type) { if(type === 'deposit') { document.getElementById('lbl-deposit').className = "flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold bg-blue-600 text-white"; document.getElementById('lbl-withdraw').className = "flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold text-gray-500"; } else { document.getElementById('lbl-deposit').className = "flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold text-gray-500"; document.getElementById('lbl-withdraw').className = "flex-1 text-center cursor-pointer py-2 rounded-md text-xs font-bold bg-orange-600 text-white"; } },
            onSpotCoinInput(v) { this.updateSpotInfo(); },
            updateSpotInfo() { const coin = document.getElementById('spot-coin').value.toUpperCase(); const type = document.querySelector('input[name="spotType"]:checked').value; const price = this.getRate(coin); document.getElementById('spot-live-price').innerText = price > 0 ? `Current: $${this.formatNumber(price)}` : ''; let bal = 0, unit = ''; if (type === 'buy') { bal = this.data.usdtBalance || this.getAssetBalance('USDT'); unit = 'USDT'; } else { bal = this.getAssetBalance(coin); unit = coin; } const balEl = document.getElementById('spot-balance-display'); if(balEl) balEl.innerText = `Avail: ${this.formatNumber(bal)} ${unit}`; },
            fillMaxSpot() { const type = document.querySelector('input[name="spotType"]:checked').value; const coin = document.getElementById('spot-coin').value.toUpperCase(); let bal = 0; if(type==='buy') { bal = this.data.usdtBalance || this.getAssetBalance('USDT'); document.getElementById('spot-total').value = bal; this.calculateSpotLogic('total'); } else { bal = this.getAssetBalance(coin); document.getElementById('spot-amount').value = bal; this.calculateSpotLogic('amount'); } },
            fillMaxDI() { const type = document.querySelector('input[name="diType"]:checked').value; const coin = document.getElementById('di-asset').value.toUpperCase(); let bal = 0; if(type === 'sell_high') bal = this.getAssetBalance(coin); else bal = this.data.usdtBalance || this.getAssetBalance('USDT'); document.getElementById('di-amount').value = bal; this.renderDICalculator(); },
            getAssetBalance(c) { const {assets, usdtBalance} = this.calculatePortfolio(); return c==='USDT'?usdtBalance:(assets[c]?assets[c].amount:0); },
            calculateSpotLogic(s) { const p=parseFloat(document.getElementById('spot-price').value)||0, a=parseFloat(document.getElementById('spot-amount').value)||0, t=parseFloat(document.getElementById('spot-total').value)||0; if(s==='price'&&a>0)document.getElementById('spot-total').value=p*a; if(s==='amount'&&p>0)document.getElementById('spot-total').value=p*a; if(s==='total'&&p>0)document.getElementById('spot-amount').value=t/p; },
        };
        window.app = app;
        document.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>